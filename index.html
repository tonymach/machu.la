<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
    <meta http-equiv="Content-Security-Policy" content="default-src 'self'; script-src 'self' 'unsafe-inline' https://cdn.jsdelivr.net; style-src 'self' 'unsafe-inline'; connect-src 'self' https://*.supabase.co https://api.anthropic.com https://api.twilio.com; img-src 'self' data:;">
    <title>machu.la</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        html { scroll-behavior: smooth; }
        /* Touch-action: eliminate 300 ms delay on all interactive elements */
        button, a, input, select, textarea, [role="button"] { touch-action: manipulation; }
        /* Active-state feedback for touch (complements :hover on desktop) */
        .board-btn:active        { background: rgba(74,222,128,.12) !important; transform: translateX(1px) !important; }
        .board-pin-submit:active { background: rgba(74,222,128,.15) !important; }
        .board-submit-btn:active { background: rgba(74,222,128,.15) !important; }
        .oracle-btn:active       { background: rgba(74,222,128,.14) !important; }
        .emergency-exit:active   { background: rgba(255,68,68,.25)  !important; }
        #vault-float-btn:active  { background: rgba(255,68,68,.25)  !important; opacity: 1 !important; }
        #admin-float-btn:active  { background: rgba(74,222,128,.2)  !important; opacity: 1 !important; }
        .admin-btn:active        { background: rgba(74,222,128,.18) !important; }
        .admin-close-btn:active  { opacity: .75; }

        body {
            font-family: Arial, sans-serif;
            line-height: 1.6;
            background: #f0ede8;
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 1rem;
            transition: background 0.8s ease;
        }

        .container {
            width: 90%; max-width: 720px;
            margin: 0 auto;
            background: white;
            box-shadow: 0 1px 4px rgba(0,0,0,0.12);
            position: relative;
            overflow: visible;
            transition: max-width 0.8s cubic-bezier(.16,1,.3,1),
                        border 0.5s ease,
                        box-shadow 0.7s ease,
                        background 0.5s ease;
        }

        /* â”€â”€â”€ BORING MODE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
        .boring-mode { position: relative; overflow: hidden; transition: opacity .4s ease; }

        .boring-shimmer {
            position: absolute; top: 0; left: 0;
            width: 45%; height: 100%;
            background: linear-gradient(
                108deg,
                transparent 30%,
                rgba(255, 215, 0, 0.07) 50%,
                rgba(255, 215, 0, 0.04) 56%,
                transparent 70%
            );
            transform: translateX(-220%);
            animation: card-sheen 14s ease-in-out infinite;
            pointer-events: none; z-index: 10;
        }
        @keyframes card-sheen {
            0%, 74%  { transform: translateX(-220%); }
            86%      { transform: translateX(420%);  }
            100%     { transform: translateX(420%);  }
        }

        .boring-header {
            padding: 28px 30px 22px;
            text-align: center;
            border-bottom: 1px solid #eee;
            background: white;
        }
        .boring-domain { font-size: 22px; color: #222; margin-bottom: 6px; letter-spacing: -0.5px; }
        .boring-tagline { color: #888; font-size: 13px; }

        .boring-content { padding: 24px 28px 10px; }

        .boring-ad {
            border: 1px solid #e0ddd9; padding: 18px 20px; margin: 10px 0;
            text-align: left; cursor: pointer;
            transition: background .3s cubic-bezier(.16,1,.3,1), border-color .3s cubic-bezier(.16,1,.3,1), transform .3s cubic-bezier(.34,1.56,.64,1);
            position: relative; overflow: hidden; border-radius: 3px;
        }
        .boring-ad:hover { background: #faf9f7; border-color: #b8b4af; transform: translateX(3px); }
        .ad-label { font-size: 10px; text-transform: uppercase; letter-spacing: 1.5px; color: #bbb; margin-bottom: 4px; }
        .ad-title { color: #1a0dab; font-size: 14px; margin-bottom: 3px; }
        .ad-url   { color: #006621; font-size: 11px; margin-bottom: 5px; }
        .ad-body  { color: #4a4a4a; font-size: 13px; line-height: 1.5; }

        .boring-divider { border: none; border-top: 1px dashed #e5e2de; margin: 16px 0; }

        .boring-footer {
            text-align: center; padding: 16px 20px 18px;
            border-top: 1px solid #eee; color: #aaa; font-size: 11px;
            background: #faf9f7;
        }

        .boring-contact-form {
            border: 1px solid #e0ddd9; border-radius: 3px;
            padding: 20px; margin: 12px 0; background: white;
        }
        .boring-input {
            width: 100%; padding: 8px 10px; margin: 5px 0 14px;
            border: 1px solid #ddd; border-radius: 3px; font-size: 13px;
        }
        .boring-submit {
            background: #1a73e8; color: white; border: none;
            padding: 9px 18px; border-radius: 3px; cursor: pointer; font-size: 13px;
        }
        .form-group { margin-bottom: 12px; font-size: 13px; color: #444; }
        .hidden { display: none !important; }
        .reveal { display: block !important; }

        /* â”€â”€â”€ TRANSITION â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
        .transition-overlay {
            display: none; position: fixed; inset: 0;
            background: #000; z-index: 10000;
            font-family: monospace; padding: 2rem;
            opacity: 0; transition: opacity .6s ease;
            justify-content: center; align-items: center;
            flex-direction: column;
        }
        .transition-overlay.active  { display: flex; }
        .transition-overlay.visible { opacity: 1; }

        .boot-log { width: min(500px, 90vw); }
        .boot-line {
            font-size: .8rem; color: #0f0; padding: .15rem 0;
            opacity: 0; transform: translateY(4px);
            transition: opacity .2s ease, transform .2s ease;
        }
        .boot-line.show  { opacity: 1; transform: translateY(0); }
        .boot-line.dim   { color: #2a6e2a; }
        .boot-line.warn  { color: #FFD700; }
        .boot-line.done  { color: #4ADE80; }
        .boot-bar-wrap {
            width: min(500px, 90vw); margin-top: 1.4rem;
            background: #050505; border: 1px solid #1a3a1a; height: 2px; overflow: hidden;
        }
        .boot-bar { height: 100%; width: 0%; background: #0f0; box-shadow: 0 0 6px #0f0; }
        .boot-pct { margin-top: .5rem; font-size: .65rem; color: #2a6e2a; letter-spacing: 2px; min-height: 1rem; }

        /* â”€â”€â”€ ANIMATIONS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
        @keyframes bounce   { 0%,100%{transform:translateY(0)} 50%{transform:translateY(-8px)} }
        @keyframes pulse    { 0%,100%{opacity:1} 50%{opacity:.65} }
        @keyframes fadeUp   { from{opacity:0;transform:translateY(24px)} to{opacity:1;transform:translateY(0)} }
        @keyframes glitch   { 0%{transform:translate(0)} 20%{transform:translate(-2px,2px)} 40%{transform:translate(-2px,-2px)} 60%{transform:translate(2px,2px)} 80%{transform:translate(2px,-2px)} 100%{transform:translate(0)} }
        @keyframes rainbow  { 0%{color:red} 17%{color:orange} 34%{color:yellow} 50%{color:lime} 67%{color:cyan} 84%{color:magenta} 100%{color:red} }
        @keyframes psychedelic {
            0%,100%{filter:hue-rotate(0deg) saturate(100%)}
            25%{filter:hue-rotate(90deg) saturate(140%)}
            50%{filter:hue-rotate(180deg) saturate(180%)}
            75%{filter:hue-rotate(270deg) saturate(140%)}
        }

        /* â”€â”€â”€ PARTY MODE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
        .party-mode { display: none; opacity: 0; transition: opacity .7s cubic-bezier(.16,1,.3,1); }
        .party-mode.active { display: block; opacity: 1; }

        body.party-active {
            background:
                radial-gradient(circle at 20% 50%, rgba(138,43,226,.25) 0%, transparent 50%),
                radial-gradient(circle at 80% 50%, rgba(75,0,130,.25) 0%, transparent 50%),
                radial-gradient(circle at 50% 20%, rgba(255,20,147,.2) 0%, transparent 50%),
                radial-gradient(circle at 50% 80%, rgba(255,215,0,.2) 0%, transparent 50%),
                repeating-conic-gradient(from 0deg at 50% 50%,
                    #FF1493 0deg, #9400D3 60deg, #4B0082 120deg,
                    #0000FF 180deg, #00FF00 240deg, #FFFF00 300deg, #FF1493 360deg);
            animation: psychedelic 22s ease-in-out infinite;
        }
        .container.party-active {
            max-width: 820px;
            border: 6px solid #FFD700;
            box-shadow: 0 0 50px rgba(255,215,0,.12), 0 0 100px rgba(255,0,255,.06);
            background: #030303;
        }

        .party-mode.active .party-header   { animation: fadeUp .8s cubic-bezier(.16,1,.3,1) both; }
        .party-mode.active .board-section  { animation: fadeUp .8s .1s cubic-bezier(.16,1,.3,1) both; }
        .party-mode.active .easter-section { animation: fadeUp .8s .22s cubic-bezier(.16,1,.3,1) both; }
        .party-mode.active .poem-section   { animation: fadeUp .8s .35s cubic-bezier(.16,1,.3,1) both; }
        .party-mode.active .oracle-section  { animation: fadeUp .8s .46s cubic-bezier(.16,1,.3,1) both; }
        .party-mode.active .vault-hint      { animation: fadeUp .8s .58s cubic-bezier(.16,1,.3,1) both; }

        .party-header {
            padding: 2rem 2.5rem; text-align: center;
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 50%, #0f3460 100%);
            border-bottom: 5px solid #FFD700;
        }
        .party-domain {
            font-size: 3.5rem; font-weight: bold;
            font-family: 'Comic Sans MS', cursive;
            text-shadow: 2px 2px 0 #ff0000, 4px 4px 0 #00ff00, 6px 6px 0 #0000ff;
            animation: bounce 2.5s infinite; color: white;
        }
        .party-sub {
            font-family: monospace; font-size: .8rem;
            color: #4ADE80; margin-top: .6rem; letter-spacing: 1px; opacity: .8;
        }

        .party-content { padding: 2rem 2.5rem; background: #030303; color: #c8ffc8; }

        /* Easter egg */
        .easter-section { padding: 1.8rem 0 2rem; border-bottom: 1px solid #1a3a1a; }
        .easter-congrats {
            font-family: monospace; font-size: 1.1rem;
            color: #4ADE80; letter-spacing: 2px; margin-bottom: 1.2rem;
        }
        .easter-body { font-size: .95rem; line-height: 1.9; color: #a0c8a0; max-width: 560px; }
        .easter-body em { color: #c8ffc8; font-style: normal; }

        /* Poem */
        .poem-section { padding: 2.5rem 0; border-bottom: 1px solid #1a3a1a; }
        .poem-grid {
            display: grid; grid-template-columns: 1fr 1fr;
            gap: 2.5rem; align-items: start;
        }
        .poem-zh {
            font-family: 'PingFang SC', 'Hiragino Sans GB', 'Microsoft YaHei', 'STSong', serif;
            font-size: 1.05rem; line-height: 2.3; color: #4ADE80;
            letter-spacing: 2px; font-weight: 400;
        }
        .poem-en {
            font-family: Georgia, 'Times New Roman', serif;
            font-size: 1.05rem; line-height: 2.3; color: #e0ffe0;
            letter-spacing: .4px; padding-top: 0; opacity: .85;
        }

        /* Vault hint */
        .vault-hint {
            padding: 1.4rem 1.8rem; border: 1px dashed #2a2020;
            font-family: monospace; text-align: center;
            background: rgba(255,40,40,.02);
        }
        .vault-hint-title { color: #ff4444; font-size: .8rem; letter-spacing: 3px; margin-bottom: .6rem; opacity: .8; }
        .vault-hint-body  { color: #3a5a3a; font-size: .78rem; line-height: 1.9; }
        .vault-hint-lock  { font-size: .68rem; margin-top: .6rem; }
        #vault-locked-hint   { color: #2a2020; }
        #vault-unlocked-hint { color: #4ADE80; display: none; }

        /* Board of Life Directors */
        .board-section { padding: 2rem 0 1.5rem; border-top: 1px solid #1a3a1a; }
        .board-label {
            font-family: monospace; font-size: .72rem;
            letter-spacing: 4px; color: #FFD700;
            text-transform: uppercase; margin-bottom: .4rem;
        }
        .board-heading {
            font-size: 1.25rem; color: #c8ffc8;
            font-family: Georgia, serif;
            margin-bottom: .5rem; font-weight: normal;
        }
        .board-desc {
            font-size: .8rem; color: #3a5a3a;
            margin-bottom: 1.8rem; line-height: 1.7; font-family: monospace;
        }
        .board-question-card {
            background: rgba(255,215,0,.03); border: 1px solid #1e3a1a;
            border-left: 3px solid #FFD700; padding: 1.4rem 1.6rem; margin-bottom: 1.6rem;
            opacity: 0; transform: translateY(12px);
            transition: opacity .6s cubic-bezier(.16,1,.3,1), transform .6s cubic-bezier(.16,1,.3,1);
        }
        .board-question-card.revealed { opacity: 1; transform: translateY(0); }
        .board-q-label { font-size: .62rem; letter-spacing: 2px; color: #4a6a2a; font-family: monospace; margin-bottom: .6rem; text-transform: uppercase; }
        .board-q-text  { font-size: 1.15rem; color: #e0ffe0; line-height: 1.7; font-family: Georgia, serif; }

        /* Option cards */
        .board-options { display: flex; flex-direction: column; gap: .55rem; margin-bottom: 1.4rem; }
        .board-btn {
            width: 100%; display: flex; align-items: center; gap: 1rem;
            background: transparent; border: 1px solid #1a3a1a;
            padding: 1rem 1.2rem; cursor: pointer;
            font-family: monospace; transition: background .3s cubic-bezier(.16,1,.3,1), border-color .3s cubic-bezier(.16,1,.3,1), transform .25s cubic-bezier(.16,1,.3,1);
            border-radius: 3px; text-align: left;
        }
        .board-btn:hover { background: rgba(74,222,128,.04); border-color: #2a5a2a; transform: translateX(2px); }
        .board-btn.selected { background: rgba(74,222,128,.07); border-color: #4ADE80; transform: translateX(3px); }
        .board-btn-indicator {
            width: 18px; height: 18px; border-radius: 50%; flex-shrink: 0;
            border: 2px solid #2a4a2a; position: relative;
            transition: border-color .3s cubic-bezier(.16,1,.3,1), background .3s cubic-bezier(.34,1.56,.64,1), transform .35s cubic-bezier(.34,1.56,.64,1);
        }
        .board-btn.selected .board-btn-indicator { border-color: #4ADE80; background: #4ADE80; transform: scale(1.15); }
        .board-btn.selected .board-btn-indicator::after {
            content: ''; position: absolute; inset: 3px;
            background: #030303; border-radius: 50%;
        }
        .board-btn-content { flex: 1; }
        .board-btn-label { display: block; font-size: .6rem; color: #2a5a2a; letter-spacing: 2px; margin-bottom: .25rem; text-transform: uppercase; transition: color .18s; }
        .board-btn.selected .board-btn-label { color: #4ADE80; }
        .board-btn-text  { display: block; font-size: .9rem; color: #a0c8a0; line-height: 1.45; transition: color .18s; }
        .board-btn.selected .board-btn-text { color: #e0ffe0; }

        /* Submit */
        .board-submit-btn {
            width: 100%; background: transparent; border: 1px solid #4ADE80;
            color: #4ADE80; padding: .85rem 1.4rem;
            cursor: pointer; font-family: monospace;
            font-size: .78rem; letter-spacing: 2px; text-transform: uppercase;
            display: none; border-radius: 3px;
            opacity: 0; transform: translateY(10px);
            pointer-events: none;
            transition: background .25s ease, opacity .55s cubic-bezier(.16,1,.3,1), transform .55s cubic-bezier(.16,1,.3,1);
        }
        .board-submit-btn:hover { background: rgba(74,222,128,.1); }
        .board-submit-btn:disabled { opacity: .5 !important; cursor: not-allowed; }
        .board-submit-btn.visible { display: block; }
        .board-submit-btn.animated { opacity: 1; transform: translateY(0); pointer-events: all; }

        /* Voted confirmation */
        .board-voted {
            text-align: center; padding: 2.5rem 1.5rem;
            border: 1px solid #1a3a1a; background: rgba(74,222,128,.03);
            animation: fadeUp .7s cubic-bezier(.16,1,.3,1) both;
        }
        .board-voted-check { font-size: 1.8rem; margin-bottom: .8rem; }
        .board-voted-title { font-family: monospace; font-size: .9rem; color: #4ADE80; letter-spacing: 2px; margin-bottom: .4rem; }
        .board-voted-sub   { font-family: monospace; font-size: .72rem; color: #2a5a2a; }

        /* PIN gate */
        .board-pin-gate { margin-bottom: 1.4rem; }
        .board-pin-label {
            font-family: monospace; font-size: .68rem;
            color: #3a5a3a; letter-spacing: 2px;
            text-transform: uppercase; margin-bottom: .7rem;
        }
        .board-pin-row { display: flex; gap: .6rem; align-items: center; }
        .board-pin-input {
            background: transparent; border: 1px solid #2a4a2a;
            color: #4ADE80; padding: .6rem .9rem;
            font-family: monospace; font-size: 1.1rem;
            letter-spacing: 8px; width: 140px; outline: none;
            border-radius: 3px; text-align: center;
            transition: border-color .2s, box-shadow .2s;
        }
        .board-pin-input:focus { border-color: #4ADE80; box-shadow: 0 0 0 1px rgba(74,222,128,.2); }
        .board-pin-input.shake { animation: pin-shake .35s ease; }
        @keyframes pin-shake {
            0%,100% { transform: translateX(0); }
            20%,60% { transform: translateX(-5px); }
            40%,80% { transform: translateX(5px); }
        }
        .board-pin-submit {
            background: transparent; border: 1px solid #2a4a2a;
            color: #4ADE80; padding: .6rem 1.1rem;
            cursor: pointer; font-family: monospace;
            font-size: .76rem; letter-spacing: 1px;
            transition: all .2s; border-radius: 3px;
        }
        .board-pin-submit:hover { background: rgba(74,222,128,.08); border-color: #4ADE80; }
        .board-pin-error {
            font-family: monospace; font-size: .7rem;
            color: #ff4444; margin-top: .55rem; letter-spacing: 1px;
        }

        /* Board meta / voter context */
        .board-meta {
            padding: .9rem 1.2rem 1rem; margin-bottom: 1rem;
            background: rgba(74,222,128,.02); border: 1px solid #1a3a1a;
            border-top: none;
            opacity: 0; transform: translateY(-8px);
            transition: opacity .5s cubic-bezier(.16,1,.3,1), transform .5s cubic-bezier(.16,1,.3,1);
        }
        .board-meta.revealed { opacity: 1; transform: translateY(0); }
        .board-meta-row { margin-bottom: .85rem; }
        .board-meta-row:last-child { margin-bottom: 0; }
        .board-meta-q {
            font-family: monospace; font-size: .65rem;
            color: #3a5a3a; letter-spacing: 1.5px;
            text-transform: uppercase; margin-bottom: .45rem;
        }
        .board-dot-row { display: flex; gap: .45rem; align-items: center; }
        .board-dot {
            width: 20px; height: 20px; border-radius: 50%;
            border: 1.5px solid #2a4a2a; cursor: pointer;
            transition: background .15s, border-color .15s, transform .12s;
            flex-shrink: 0;
        }
        .board-dot:hover { border-color: #4ADE80; transform: scale(1.12); }
        .board-dot.filled { background: rgba(74,222,128,.6); border-color: #4ADE80; }
        .board-dot-label { font-family: monospace; font-size: .62rem; color: #4ADE80; margin-left: .4rem; min-width: 80px; }
        .board-meta-textarea {
            width: 100%; background: transparent;
            border: 1px solid #1a3a1a; border-radius: 3px;
            color: #a0c8a0; padding: .55rem .8rem;
            font-family: monospace; font-size: .8rem;
            resize: none; height: 60px; outline: none;
            transition: border-color .2s; line-height: 1.5;
        }
        .board-meta-textarea:focus { border-color: #4ADE80; }
        .board-meta-textarea::placeholder { color: #2a4a2a; font-style: italic; }

        /* Admin question history */
        .admin-q-history-item {
            border: 1px solid #1a3a1a; border-radius: 2px;
            padding: .65rem .8rem; margin-bottom: .45rem; transition: background .15s;
        }
        .admin-q-history-item:hover { background: rgba(74,222,128,.02); }
        .admin-q-history-item.active-q { border-left: 3px solid #4ADE80; border-color: #4ADE80; }

        /* Party footer */
        .party-footer {
            text-align: center; padding: 1.2rem 2rem;
            background: #030303; border-top: 4px solid #4ADE80;
            color: #2a6e2a; font-family: monospace; font-size: .7rem; letter-spacing: 2px;
        }

        /* Buttons */
        .emergency-exit {
            display: none; position: fixed; top: 10px; right: 10px;
            background: rgba(0,0,0,.85); color: #ff4444; border: 1px solid #ff4444;
            padding: 7px 14px; cursor: pointer; font-family: monospace;
            z-index: 1000; border-radius: 3px; font-size: .72rem; letter-spacing: 1px;
            transition: all .2s;
        }
        .emergency-exit:hover { background: #ff4444; color: white; }
        .emergency-exit.active { display: block; }

        #vault-float-btn {
            display: none; position: fixed; bottom: 12px; left: 12px;
            background: rgba(5,0,0,.92); color: #ff4444; border: 1px solid #ff4444;
            padding: 6px 12px; cursor: pointer; font-family: monospace;
            font-size: .7rem; z-index: 999; border-radius: 3px;
            transition: all .2s; opacity: .65; letter-spacing: 1px;
        }
        #vault-float-btn:hover { opacity: 1; background: #ff4444; color: white; }

        @media (max-width: 640px) {
            /* â”€â”€ Layout â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
            body { padding: 0; align-items: flex-start; -webkit-font-smoothing: antialiased; -moz-osx-font-smoothing: grayscale; }
            .container { width: 100%; border-radius: 0; box-shadow: none; }

            /* â”€â”€ Boring mode â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
            .boring-header       { padding: 24px 18px 18px; padding-top: max(24px, env(safe-area-inset-top, 24px)); }
            .boring-domain       { font-size: 20px; }
            .boring-content      { padding: 16px 16px 8px; }
            .boring-ad           { padding: 16px; min-height: 52px; }
            .boring-contact-form { padding: 16px; }
            .boring-footer       { padding: 14px 16px; font-size: 11px; padding-bottom: max(14px, env(safe-area-inset-bottom, 14px)); }

            /* â”€â”€ Party header â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
            .party-header { padding: 1.5rem 1.1rem; padding-top: max(1.5rem, calc(env(safe-area-inset-top, 0px) + 1.1rem)); }
            .party-domain { font-size: clamp(2rem, 12vw, 3rem); }
            .party-sub    { font-size: .68rem; }

            /* â”€â”€ Party content â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
            .party-content { padding: 1rem 1rem 1.8rem; }

            /* â”€â”€ Sections â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
            .board-section  { padding-bottom: 1.5rem; margin-bottom: .8rem; }
            .easter-section { padding: 1.4rem 0 1.6rem; }
            .poem-section   { padding: 1.6rem 0; }
            .oracle-section { padding: 1.3rem 1rem; }
            .vault-hint     { padding: 1rem 0; }

            /* â”€â”€ Board headings â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
            .board-label   { font-size: .6rem; }
            .board-heading { font-size: 1.05rem; line-height: 1.4; }
            .board-desc    { font-size: .78rem; line-height: 1.6; }

            /* â”€â”€ Board PIN â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
            .board-pin-row    { flex-direction: column; gap: .6rem; }
            .board-pin-input  { width: 100%; font-size: 18px; letter-spacing: 10px; padding: .8rem 1rem; min-height: 52px; border-radius: 8px; }
            .board-pin-submit { width: 100%; min-height: 52px; font-size: .84rem; border-radius: 8px; padding: .8rem 1rem; }
            .board-pin-error  { font-size: .72rem; }

            /* â”€â”€ Board options â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
            .board-options    { flex-direction: column; gap: .6rem; }
            .board-btn        { padding: 1rem 1.1rem; min-height: 56px; border-radius: 8px; }
            .board-btn-text   { font-size: .84rem; }
            .board-btn-label  { font-size: .62rem; }

            /* â”€â”€ Board submit â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
            .board-submit-btn { min-height: 52px; font-size: .84rem; border-radius: 8px; letter-spacing: 1.5px; }

            /* â”€â”€ Board voted â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
            .board-voted       { padding: 2rem 1.2rem; border-radius: 8px; }
            .board-voted-title { font-size: .85rem; }

            /* â”€â”€ Board meta dot ratings â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
            .board-dot          { width: 26px; height: 26px; }
            .board-meta-q       { font-size: .63rem; }
            .board-meta         { padding: .9rem 1rem 1rem; border-radius: 0 0 8px 8px; }
            .board-dot-row      { gap: .55rem; flex-wrap: wrap; }
            .board-meta-textarea { font-size: 16px; height: 76px; padding: .7rem .9rem; border-radius: 6px; }

            /* â”€â”€ Poem â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
            .poem-grid { grid-template-columns: 1fr; gap: 1.3rem; }
            .poem-zh   { font-size: 1.1rem; text-align: center; }
            .poem-en   { font-size: .86rem; text-align: center; line-height: 1.7; }

            /* â”€â”€ Oracle â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
            .oracle-input-row { flex-direction: column; gap: .6rem; }
            .oracle-input     { font-size: 16px; padding: .75rem .9rem; min-height: 50px; border-radius: 8px; }
            .oracle-btn       { width: 100%; min-height: 50px; font-size: .84rem; border-radius: 8px; padding: .75rem 1rem; }
            .oracle-heading   { font-size: .9rem; }
            .oracle-answer    { font-size: .84rem; line-height: 1.68; }

            /* â”€â”€ Network â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
            .network-form-row { flex-direction: column; gap: .6rem; }
            .network-input    { min-width: unset; width: 100%; font-size: 16px; min-height: 50px; border-radius: 8px; }
            .network-heading  { font-size: .9rem; }

            /* â”€â”€ Float buttons â€” safe-area aware â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
            .emergency-exit {
                top: max(10px, env(safe-area-inset-top, 10px));
                right: max(10px, env(safe-area-inset-right, 10px));
                padding: 8px 14px; font-size: .65rem; min-height: 36px; border-radius: 20px;
            }
            #vault-float-btn {
                bottom: max(14px, env(safe-area-inset-bottom, 14px));
                left: max(12px, env(safe-area-inset-left, 12px));
                padding: 9px 14px; font-size: .65rem; min-height: 36px; border-radius: 20px;
            }
            #admin-float-btn {
                bottom: max(14px, env(safe-area-inset-bottom, 14px));
                left: calc(max(12px, env(safe-area-inset-left, 12px)) + 96px);
                padding: 9px 14px; font-size: .65rem; min-height: 36px; border-radius: 20px;
            }

            /* â”€â”€ Admin overlay â€” bottom sheet â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
            .admin-overlay.active {
                display: flex !important;
                flex-direction: column;
                justify-content: flex-end;
                background: rgba(0,0,0,.65);
                backdrop-filter: blur(6px);
                -webkit-backdrop-filter: blur(6px);
            }
            .admin-container {
                border-radius: 18px 18px 0 0;
                max-height: 90vh;
                overflow-y: auto;
                -webkit-overflow-scrolling: touch;
                padding: 1rem 1rem max(1rem, env(safe-area-inset-bottom, 1rem));
                background: #020c02;
                border: 1px solid #1a3a1a;
                border-bottom: none;
            }
            /* Drag handle pill */
            .admin-container::before {
                content: '';
                display: block;
                width: 36px; height: 4px;
                background: #2a4a2a;
                border-radius: 2px;
                margin: 0 auto .9rem;
            }
            .admin-title    { font-size: 1rem; letter-spacing: 2px; }
            .admin-subtitle { font-size: .58rem; }
            .admin-close-btn { padding: 8px 14px; min-height: 36px; border-radius: 6px; }
            .admin-tabs     { flex-wrap: nowrap; overflow-x: auto; -webkit-overflow-scrolling: touch; gap: 0; padding-bottom: 2px; }
            .admin-tab      { font-size: .6rem; padding: .42rem .7rem; letter-spacing: .5px; white-space: nowrap; min-height: 36px; }
            .admin-table    { font-size: .72rem; }
            .admin-table th, .admin-table td { padding: .42rem .45rem; }
            .admin-input    { font-size: 16px; min-height: 44px; border-radius: 6px; }
            .admin-btn      { min-height: 40px; font-size: .72rem; border-radius: 6px; padding: .5rem 1rem; }
            .admin-section  { overflow-x: auto; -webkit-overflow-scrolling: touch; }

            /* â”€â”€ Vault overlay â€” bottom sheet â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
            .vault-overlay.active {
                display: flex !important;
                flex-direction: column;
                justify-content: flex-end;
                background: rgba(0,0,0,.65);
                backdrop-filter: blur(6px);
                -webkit-backdrop-filter: blur(6px);
            }
            .vault-container {
                border-radius: 18px 18px 0 0;
                max-height: 90vh;
                overflow-y: auto;
                -webkit-overflow-scrolling: touch;
                padding: 1rem 1rem max(1rem, env(safe-area-inset-bottom, 1rem));
                background: #0c0000;
                border: 1px solid #3a1010;
                border-bottom: none;
            }
            .vault-container::before {
                content: '';
                display: block;
                width: 36px; height: 4px;
                background: #3a1010;
                border-radius: 2px;
                margin: 0 auto .9rem;
            }
            .vault-title    { font-size: 1.2rem; letter-spacing: 3px; }
            .vault-textarea { font-size: 16px; }

            /* â”€â”€ Party footer â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
            .party-footer { font-size: .6rem; padding: .9rem 1rem; padding-bottom: max(calc(.9rem + env(safe-area-inset-bottom, 0px)), 1rem); letter-spacing: 1px; }
        }

        /* â”€â”€â”€ ORACLE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
        .oracle-section {
            border: 1px solid #1a3a1a; border-radius: 4px;
            padding: 1.5rem 1.8rem; margin: 0 0 .8rem;
            background: rgba(74,222,128,.015);
        }
        .oracle-label {
            font-family: monospace; font-size: .62rem; color: #4ADE80;
            letter-spacing: 3px; text-transform: uppercase; margin-bottom: .35rem;
        }
        .oracle-heading {
            font-size: .95rem; color: #c0f0c0; margin-bottom: .9rem; font-family: monospace;
        }
        .oracle-input-row { display: flex; gap: .6rem; align-items: stretch; }
        .oracle-input {
            flex: 1; background: transparent; border: 1px solid #1a3a1a; border-radius: 3px;
            color: #a0d0a0; padding: .65rem .9rem; font-family: monospace; font-size: .82rem;
            outline: none; transition: border-color .3s cubic-bezier(.16,1,.3,1);
        }
        .oracle-input:focus { border-color: #4ADE80; }
        .oracle-input::placeholder { color: #2a4a2a; }
        .oracle-btn {
            background: transparent; border: 1px solid #4ADE80; color: #4ADE80;
            padding: .65rem 1.2rem; font-family: monospace; font-size: .72rem;
            letter-spacing: 1.5px; text-transform: uppercase; cursor: pointer; border-radius: 3px;
            transition: background .25s ease, transform .3s cubic-bezier(.34,1.56,.64,1);
            white-space: nowrap;
        }
        .oracle-btn:hover { background: rgba(74,222,128,.1); transform: scale(1.04); }
        .oracle-btn:disabled { opacity: .5; cursor: not-allowed; transform: none; }
        .oracle-response {
            margin-top: 1.1rem;
            opacity: 0; transform: translateY(8px);
            transition: opacity .5s cubic-bezier(.16,1,.3,1), transform .5s cubic-bezier(.16,1,.3,1);
        }
        .oracle-response.revealed { opacity: 1; transform: translateY(0); }
        .oracle-scanning { font-family: monospace; font-size: .7rem; color: #3a6a3a; letter-spacing: 2px; min-height: 1.4em; }
        .oracle-scan-bar {
            display: inline-block; width: 7px; height: .8em;
            background: #4ADE80; margin-left: 4px; vertical-align: middle;
            animation: cur-blink .55s step-end infinite;
        }
        @keyframes cur-blink { 50% { opacity: 0; } }
        .oracle-answer {
            font-family: monospace; font-size: .88rem; color: #d0f0d0;
            line-height: 1.75; border-left: 2px solid #4ADE80; padding-left: .9rem;
            margin-top: .6rem;
            opacity: 0; transform: translateY(6px);
            transition: opacity .6s cubic-bezier(.16,1,.3,1), transform .6s cubic-bezier(.16,1,.3,1);
        }
        .oracle-answer.revealed { opacity: 1; transform: translateY(0); }

        /* Oracle connect form â€” revealed on right question */
        .oracle-connect {
            margin-top: .9rem; padding-top: .9rem;
            border-top: 1px solid #1a3a1a;
            opacity: 0; transform: translateY(8px);
            transition: opacity .6s cubic-bezier(.16,1,.3,1), transform .6s cubic-bezier(.16,1,.3,1);
        }
        .oracle-connect.revealed { opacity: 1; transform: translateY(0); }
        .oracle-connect-intro {
            font-family: monospace; font-size: .72rem; color: #4a7a4a;
            margin-bottom: .75rem; letter-spacing: .5px; line-height: 1.6;
        }
        .oracle-connect-fields { display: flex; flex-direction: column; gap: .5rem; }
        .oracle-connect-sent {
            font-family: monospace; font-size: .8rem; color: #4ADE80;
            letter-spacing: 1px; text-align: center; padding: .6rem 0;
            display: none;
        }


        /* â”€â”€â”€ ADMIN OVERLAY â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
        .admin-overlay {
            display:none; position:fixed; inset:0; background:rgba(0,4,20,.98);
            z-index:4000; overflow-y:auto; font-family:monospace;
            opacity:0; transform:translateY(14px);
            transition: opacity .45s cubic-bezier(.16,1,.3,1), transform .45s cubic-bezier(.16,1,.3,1);
        }
        .admin-overlay.active { display:block; }
        .admin-overlay.shown  { opacity:1; transform:translateY(0); }
        .admin-container { max-width:860px; margin:0 auto; padding:1.5rem; }
        .admin-header { text-align:center; border-bottom:2px solid #4ADE80; padding-bottom:1rem; margin-bottom:1.5rem; position:relative; }
        .admin-title { font-size:1.4rem; color:#4ADE80; letter-spacing:4px; text-transform:uppercase; }
        .admin-subtitle { font-size:.68rem; color:#2a4a2a; letter-spacing:3px; margin-top:.3rem; text-transform:uppercase; }
        .admin-close-btn { position:absolute; top:0; right:0; background:#4ADE80; color:#030303; border:none; padding:7px 14px; cursor:pointer; font-family:monospace; font-size:.8rem; font-weight:bold; }
        .admin-tabs { display:flex; gap:0; margin-bottom:1.5rem; border-bottom:1px solid #1a3a1a; }
        .admin-tab { background:transparent; border:none; border-bottom:2px solid transparent; color:#2a5a2a; padding:.5rem 1.1rem; cursor:pointer; font-family:monospace; font-size:.75rem; letter-spacing:1px; text-transform:uppercase; margin-bottom:-1px; transition:all .2s; }
        .admin-tab:hover { color:#4ADE80; }
        .admin-tab.active { color:#4ADE80; border-bottom-color:#4ADE80; }
        .admin-panel { display:none; }
        .admin-panel.active { display:block; }
        .admin-section { margin-bottom:1.4rem; }
        .admin-label { font-size:.65rem; letter-spacing:2px; color:#2a5a2a; text-transform:uppercase; margin-bottom:.5rem; }
        .admin-input { width:100%; background:#060606; border:1px solid #1a3a1a; color:#c8ffc8; padding:.5rem .8rem; font-family:monospace; font-size:.82rem; outline:none; box-sizing:border-box; margin-bottom:.5rem; border-radius:2px; }
        .admin-input:focus { border-color:#4ADE80; }
        .admin-btn { background:transparent; border:1px solid #4ADE80; color:#4ADE80; padding:.42rem .85rem; cursor:pointer; font-family:monospace; font-size:.72rem; letter-spacing:1px; transition:all .2s; margin-right:.4rem; margin-bottom:.4rem; border-radius:2px; }
        .admin-btn:hover { background:rgba(74,222,128,.1); }
        .admin-btn.primary { background:rgba(74,222,128,.1); }
        .admin-btn:disabled { opacity:.4; cursor:not-allowed; }
        .admin-table { width:100%; border-collapse:collapse; font-size:.75rem; }
        .admin-table th { color:#2a5a2a; text-align:left; padding:.3rem .5rem; border-bottom:1px solid #1a3a1a; letter-spacing:1px; text-transform:uppercase; font-size:.63rem; }
        .admin-table td { color:#c8ffc8; padding:.42rem .5rem; border-bottom:1px solid #0a1a0a; vertical-align:middle; }
        .admin-table tr:hover td { background:rgba(74,222,128,.025); }
        .admin-badge { display:inline-block; padding:1px 6px; font-size:.62rem; border-radius:2px; }
        .admin-badge.used   { background:rgba(255,68,68,.1); color:#ff8888; border:1px solid #3a1010; }
        .admin-badge.unused { background:rgba(74,222,128,.1); color:#4ADE80; border:1px solid #1a3a1a; }
        .admin-key-gate { text-align:center; padding:2.5rem; border:1px dashed #1a3a1a; }
        .admin-current-q { color:#4ADE80; font-size:.85rem; padding:.7rem; border:1px solid #1a3a1a; background:#060606; margin-bottom:.8rem; line-height:1.6; }
        #admin-float-btn { display:none; position:fixed; bottom:12px; left:120px; background:rgba(0,5,20,.92); color:#4ADE80; border:1px solid #4ADE80; padding:6px 12px; cursor:pointer; font-family:monospace; font-size:.7rem; z-index:999; border-radius:3px; transition:all .2s; opacity:.65; letter-spacing:1px; }
        #admin-float-btn:hover { opacity:1; background:rgba(74,222,128,.1); }

        /* â”€â”€â”€ VAULT OVERLAY â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
        .vault-overlay {
            display:none; position:fixed; inset:0; background:rgba(2,0,0,.98);
            z-index:3000; overflow-y:auto; font-family:monospace;
            opacity:0; transform:translateY(14px);
            transition: opacity .45s cubic-bezier(.16,1,.3,1), transform .45s cubic-bezier(.16,1,.3,1);
        }
        .vault-overlay.active { display:block; }
        .vault-overlay.shown  { opacity:1; transform:translateY(0); }
        .vault-container { max-width:860px; margin:0 auto; padding:1.5rem; }
        .vault-header { text-align:center; border-bottom:2px solid #ff4444; padding-bottom:1rem; margin-bottom:1.5rem; position:relative; }
        .vault-title { font-size:1.8rem; color:#ff4444; letter-spacing:5px; text-transform:uppercase; text-shadow:0 0 20px rgba(255,68,68,.5); }
        .vault-subtitle { font-size:.68rem; color:#444; letter-spacing:3px; margin-top:.3rem; text-transform:uppercase; }
        .vault-close-btn { position:absolute; top:0; right:0; background:#ff4444; color:white; border:none; padding:7px 14px; cursor:pointer; font-family:monospace; font-size:.8rem; transition:background .2s; }
        .vault-close-btn:hover { background:#ff6666; }
        .vault-status { background:rgba(20,0,0,.9); border:1px solid #ff4444; border-left:3px solid #4ADE80; padding:.4rem 1rem; margin-bottom:1.4rem; font-size:.75rem; color:#4ADE80; display:flex; align-items:center; gap:.5rem; }
        .vault-status-dot { width:7px; height:7px; border-radius:50%; background:#4ADE80; flex-shrink:0; animation:pulse 2s infinite; }
        .vault-status-dot.error { background:#ff4444; animation:none; }
        .vault-status-dot.connecting { background:#FFD700; }
        .vault-content { margin-bottom:1.5rem; }
        .vault-section { margin-bottom:1.1rem; border:1px solid #3a1010; border-radius:3px; overflow:hidden; }
        .vault-section-header { background:rgba(20,0,0,.95); padding:.5rem 1rem; border-bottom:1px solid #3a1010; display:flex; align-items:baseline; gap:.6rem; }
        .vault-section-name { font-size:.78rem; color:#ff8888; font-weight:bold; text-transform:uppercase; letter-spacing:1px; }
        .vault-section-desc { font-size:.68rem; color:#553333; }
        .vault-section-content { padding:.65rem; background:rgba(8,0,0,.9); }
        .vault-records { display:flex; flex-direction:column; gap:.5rem; }
        .vault-entry { border:1px solid #2a1010; border-left:3px solid #ff4444; padding:.6rem; background:rgba(15,0,0,.8); word-break:break-word; }
        .vault-entry-main { font-size:.85rem; color:#ffaaaa; line-height:1.5; margin-bottom:.3rem; }
        .vault-entry-date { font-size:.62rem; color:#553333; }
        .vault-entry-tags { display:flex; gap:.3rem; flex-wrap:wrap; margin-top:.2rem; }
        .vault-tag { background:rgba(255,68,68,.07); border:1px solid #3a1010; color:#ff8888; padding:1px 5px; font-size:.6rem; border-radius:2px; }
        .vault-loading { color:#553333; font-size:.78rem; }
        .vault-empty { color:#443333; font-size:.75rem; font-style:italic; }
        .vault-error { color:#ff4444; font-size:.75rem; }
        .vault-error-state { text-align:center; padding:2rem; border:1px dashed #ff4444; color:#ffaaaa; }
        .vault-input-area { border:1px solid #3a1010; border-top:2px solid #ff4444; border-radius:3px; padding:.9rem; background:rgba(10,0,0,.95); margin-top:1.4rem; }
        .vault-input-title { font-size:.72rem; color:#ff8888; letter-spacing:2px; margin-bottom:.65rem; text-transform:uppercase; }
        .vault-textarea { width:100%; background:black; border:1px solid #3a1010; color:#ffaaaa; padding:.65rem; font-family:monospace; font-size:.82rem; resize:vertical; min-height:75px; outline:none; box-sizing:border-box; }
        .vault-textarea:focus { border-color:#ff4444; }
        .vault-textarea::placeholder { color:#332222; font-style:italic; }
        .vault-input-controls { display:flex; gap:.5rem; margin-top:.65rem; flex-wrap:wrap; align-items:center; }
        .vault-btn { background:transparent; border:1px solid #ff4444; color:#ff8888; padding:6px 12px; cursor:pointer; font-family:monospace; font-size:.74rem; transition:all .2s; }
        .vault-btn:hover { background:#ff4444; color:white; }
        .vault-btn.primary { background:#ff4444; color:white; font-weight:bold; }
        .vault-btn.primary:hover { background:#ff6666; }
        .vault-btn.recording { background:#ff4444; color:white; animation:pulse .8s infinite; }
        .vault-btn:disabled { opacity:.4; cursor:not-allowed; }
        .vault-select { flex-grow:1; background:black; border:1px solid #3a1010; color:#ff8888; padding:6px; font-family:monospace; font-size:.74rem; outline:none; }
        .vault-text-result { font-size:.82rem; color:#ffaaaa; line-height:1.55; }
    </style>
</head>
<body>

<!-- â”€â”€ TRANSITION OVERLAY â”€â”€ -->
<div class="transition-overlay" id="transition-overlay">
    <div class="boot-log" id="boot-log"></div>
    <div class="boot-bar-wrap"><div class="boot-bar" id="boot-bar"></div></div>
    <div class="boot-pct" id="boot-pct"></div>
</div>

<div class="container" id="main-container">

    <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
         BORING MODE (parked domain)
         â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
    <div class="boring-mode" id="boring-mode">
        <div class="boring-header">
            <div class="boring-domain">machu.la</div>
            <div class="boring-tagline">This domain is parked. Bids accepted in most currencies.</div>
        </div>

        <div class="boring-shimmer" aria-hidden="true"></div>

        <div class="boring-content">

            <div class="boring-ad" data-trigger="domain">
                <div class="ad-label">Sponsored</div>
                <div class="ad-title">Premium Cognitive Real Estate â€” Acquiring Now</div>
                <div class="ad-url">cortex-capital.io â€º acquisitions â€º frontal-lobe</div>
                <div class="ad-body">Prefrontal cortex leaseback options available. Amygdala overrides delivered Q4. <span style="color:#888">Hippocampus Premium tier: now enrolling.</span></div>
            </div>

            <div class="boring-ad" data-trigger="hosting">
                <div class="ad-label">Sponsored</div>
                <div class="ad-title">Full Limbic Recalibration â€” Neural Enhancement Suite</div>
                <div class="ad-url">pathforwardneurotech.com â€º optimize â€º defaults</div>
                <div class="ad-body">Default mode network override. Pattern interrupt at the neurological level. <span style="color:#888">One (1) genuine epiphany included. Results may include clarity, mild vertigo, and an inexplicable urge to rethink everything.</span></div>
            </div>

            <div class="boring-ad" data-trigger="contact">
                <div class="ad-label">Sponsored</div>
                <div class="ad-title">Speaking Engagements &amp; Consulting â€” $2,400/hr</div>
                <div class="ad-url">anthonymachula.ca â€º speaking â€º inquiries</div>
                <div class="ad-body">Brain optimization. Pattern interrupts. Decisions that scale. Limited availability. <span style="color:#888">Your organization's amygdala will thank you.</span></div>
            </div>

            <div id="contact-form-section" class="boring-contact-form" style="display:none;">
                <div style="text-align:right;">
                    <button class="close-form" style="border:none;background:none;color:#999;cursor:pointer;font-size:12px;">âœ• close</button>
                </div>
                <form id="boring-contact-form" method="POST" action="https://formspree.io/f/REPLACE_WITH_YOUR_FORM_ID" style="color:#333;">
                    <input type="hidden" name="_subject" value="Neural Sprint Inquiry ðŸ§ ">
                    <h3 style="color:#1a0dab;margin-bottom:16px;font-size:15px;">Contact Domain Broker</h3>
                    <div class="form-group">
                        <label>Your "Real" Name:</label>
                        <input type="text" name="name" id="name-input" class="boring-input" placeholder="We both know it's not your real name...">
                    </div>
                    <div class="form-group hidden" id="email-field">
                        <label>Neural Sprint Invoice Email:</label>
                        <input type="email" name="email" class="boring-input" placeholder="For the bill. Non-negotiable.">
                    </div>
                    <div class="form-group hidden" id="reality-check">
                        <label>Existence Validation:</label>
                        <select name="existence" class="boring-input">
                            <option>*sigh* Please select...</option>
                            <option>Yes, I definitely exist (sure you do)</option>
                            <option>I think, therefore I might exist?</option>
                            <option>My LinkedIn says I'm real</option>
                            <option>Error 404: Self not found</option>
                            <option value="trigger">ALL GLORY TO THE HYPNOTOAD</option>
                        </select>
                    </div>
                    <div class="form-group hidden" id="intent-field">
                        <label>Why Are You Really Here?</label>
                        <select name="intent" class="boring-input">
                            <option>Oh, let me guess...</option>
                            <option>Procrastinating something that would genuinely change my life</option>
                            <option>My cold plunge timer ran out</option>
                            <option>Looking for meaning in parked domains (found some?)</option>
                            <option>My cat walked on the keyboard â€” and honestly had a point</option>
                            <option>A Notion doc full of Naval quotes sent me here</option>
                        </select>
                    </div>
                    <div class="form-group hidden" id="budget-field">
                        <label>Your "Budget":</label>
                        <select name="budget" class="boring-input">
                            <option>Pick your imaginary budget...</option>
                            <option>The lint in my Lululemon pocket</option>
                            <option>Three fiddy and a microdose</option>
                            <option>One slightly pre-optimized soul</option>
                            <option>âˆž exposure, LinkedIn reach, and vibes</option>
                        </select>
                    </div>
                    <div class="form-group hidden" id="captcha-field">
                        <label>Human Verification:</label>
                        <div class="boring-input" style="text-align:center;cursor:pointer;color:#666;">
                            Please click all squares containing existential dread
                            <div style="margin-top:8px;font-style:italic;font-size:11px;">[ Error: All squares contain existential dread ]</div>
                        </div>
                    </div>
                    <button type="submit" class="boring-submit">Submit (if you must)</button>
                    <div style="text-align:center;margin-top:8px;font-size:10px;color:#aaa;">
                        * All responses will be carefully read and then manifested
                    </div>
                </form>
            </div>
        </div>

        <div class="boring-footer">
            <div>Â© 2025 Domain Parking Service &nbsp;Â·&nbsp; All Dimensions Reserved</div>
            <div style="margin-top:6px;">
                Visitors today: 1,337 &nbsp;Â·&nbsp;
                Neurons fired: <span id="sneak-attack" style="cursor:pointer;text-decoration:underline dotted;">âˆž</span>
            </div>
        </div>
    </div>


    <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
         PARTY MODE
         â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
    <div class="party-mode" id="party-mode">

        <div class="party-header">
            <div class="party-domain">machu.la</div>
            <div class="party-sub">
                Enlightenment Level: <span id="stardate"></span>
            </div>
        </div>

        <div class="party-content">

            <!-- Board of Life Directors -->
            <div class="board-section">
                <div class="board-label">ðŸª‘ The Board of Life Directors</div>
                <div class="board-heading">Major decisions deserve more than one operating system.</div>
                <div class="board-desc">
                    If you're here, I probably sent you this link.
                    There's a real question below. Your vote matters and goes directly to my consciousness cloudâ„¢.
                </div>

                <!-- PIN gate -->
                <div class="board-pin-gate" id="board-pin-gate">
                    <div class="board-pin-label">Board access PIN required</div>
                    <div class="board-pin-row">
                        <input type="password" class="board-pin-input" id="board-pin-input" maxlength="8" placeholder="Â· Â· Â· Â·" autocomplete="off">
                        <button class="board-pin-submit" id="board-pin-submit">Unlock â†—</button>
                    </div>
                    <div class="board-pin-error hidden" id="board-pin-error">âš  Incorrect PIN</div>
                </div>

                <div id="board-question-card" class="board-question-card" style="display:none;">
                    <div class="board-q-label">Current question before the board:</div>
                    <div class="board-q-text" id="board-q-text"></div>
                </div>

                <div id="board-vote-area" style="display:none;">
                    <div class="board-options" id="board-options"></div>
                    <!-- Voter context â€” revealed after selecting an option -->
                    <div class="board-meta" id="board-meta" style="display:none;">
                        <div class="board-meta-row">
                            <div class="board-meta-q">How close are you to this issue?</div>
                            <div id="board-dots-closeness"></div>
                        </div>
                        <div class="board-meta-row">
                            <div class="board-meta-q">How well can you speak to your answer?</div>
                            <div id="board-dots-expertise"></div>
                        </div>
                        <div class="board-meta-row">
                            <textarea class="board-meta-textarea" id="board-justification" placeholder="Optional: a sentence or two on your reasoning..."></textarea>
                        </div>
                    </div>
                    <button class="board-submit-btn" id="board-submit">Cast vote â†—</button>
                </div>

                <div class="board-voted hidden" id="board-voted">
                    <div class="board-voted-check">âœ¦</div>
                    <div class="board-voted-title">Vote received.</div>
                    <div class="board-voted-sub">This genuinely helps â€” thank you.</div>
                </div>
            </div>

            <!-- Easter egg welcome -->
            <div class="easter-section">
                <div class="easter-congrats">âœ¦ &nbsp; You made it. &nbsp; âœ¦</div>
                <div class="easter-body">
                    Most people see a parked domain and move on.
                    You kept going â€” which probably says something about you.<br><br>
                    This is <em>my corner of the internet</em>. No product. No funnel.
                    Just a poem, and maybe if you have the right PIN, a few buttons to click
                    to help me make decisions.
                </div>
            </div>

            <!-- Poem: Chinese left, English right -->
            <div class="poem-section">
                <div class="poem-grid">
                    <div class="poem-zh" lang="zh">
                        æž—åŽ»æ ‘ç•™ã€‚<br>
                        é“å¤±è¶³è¯†ã€‚<br>
                        èµ·è½ä¹‹é—´ï¼Œ<br>
                        ç”Ÿå‘½å¦‚æ˜¯ã€‚
                    </div>
                    <div class="poem-en">
                        The forest disappears.<br>
                        The trees remain.<br>
                        We forget the way.<br>
                        Our feet remember.<br>
                        Life, in its falling and rising.
                    </div>
                </div>
            </div>

            <!-- Oracle -->
            <div class="oracle-section">
                <div class="oracle-label">ðŸ”® the oracle</div>
                <div class="oracle-heading">Ask anything. Results may be accurate.</div>
                <div class="oracle-input-row">
                    <input type="text" class="oracle-input" id="oracle-input" placeholder="What's weighing on you..." autocomplete="off">
                    <button class="oracle-btn" id="oracle-ask">Consult â†—</button>
                </div>
                <div class="oracle-response" id="oracle-response">
                    <div class="oracle-scanning" id="oracle-scanning"></div>
                    <div class="oracle-answer" id="oracle-answer"></div>
                    <div class="oracle-connect" id="oracle-connect">
                        <div class="oracle-connect-intro">This goes directly to Anthony. No automation. Real conversation.</div>
                        <div class="oracle-connect-fields">
                            <input type="text"  class="oracle-input" id="oc-name"    placeholder="Your name">
                            <input type="text"  class="oracle-input" id="oc-contact" placeholder="Phone (+1 647â€¦ or +49 176â€¦) Â· Signal Â· email">
                        </div>
                        <button class="oracle-btn" id="oc-submit" style="width:100%;margin-top:.6rem;">Leave coordinates â†—</button>
                        <div class="oracle-connect-sent" id="oc-sent">âœ¦ &nbsp; Received. Expect something real. &nbsp; âœ¦</div>
                    </div>
                </div>
            </div>


            <!-- Classified vault â€” for the initiated -->
            <div class="vault-hint">
                <div class="vault-hint-body">
                    [ EVIDENCE VAULT â€” ENCRYPTED ]
                </div>
                <div class="vault-hint-lock">
                    <span id="vault-locked-hint">ðŸ” locked</span>
                    <span id="vault-unlocked-hint">âœ… Vault unlocked â€” tap ðŸ” VAULT â†™</span>
                </div>
            </div>

        </div>

        <div class="party-footer">
            âš¡ &nbsp; POWERED BY NEUROPLASTICITY &amp; PURE HUBRIS &nbsp; âš¡
        </div>
    </div>
</div>

<button class="emergency-exit" title="Boss Key">â†© EXIT</button>
<button id="vault-float-btn">ðŸ” VAULT</button>
<button id="admin-float-btn">âš™ BOARD ADMIN</button>

<!-- â”€â”€ BOARD ADMIN OVERLAY â”€â”€ -->
<div id="admin-overlay" class="admin-overlay">
    <div class="admin-container">
        <div class="admin-header">
            <div class="admin-title">âš™ Board Admin</div>
            <div class="admin-subtitle">pins Â· questions Â· results Â· network</div>
            <button id="admin-close" class="admin-close-btn">âœ• CLOSE</button>
        </div>
        <div id="admin-key-gate" class="admin-key-gate">
            <div style="color:#2a5a2a;font-size:.75rem;letter-spacing:1px;margin-bottom:.8rem;">SERVICE KEY REQUIRED</div>
            <div style="color:#3a5a3a;font-size:.72rem;line-height:1.8;">Visit <code style="color:#4ADE80;">machu.la/#sb-admin-YOUR_SERVICE_ROLE_KEY</code><br>to unlock admin on this device</div>
        </div>
        <div id="admin-main" style="display:none;">
            <!-- admin panel HTML + JS loaded dynamically from admin-ui edge function after key auth -->
        </div>
    </div>
</div>

<!-- â”€â”€ PROOF VAULT OVERLAY â”€â”€ -->
<div id="vault-overlay" class="vault-overlay">
    <div class="vault-container">
        <div class="vault-header">
            <div class="vault-title">ðŸ” Proof Vault</div>
            <div class="vault-subtitle">evidence-based reality anchor</div>
            <button id="vault-close" class="vault-close-btn">âœ• SEAL</button>
        </div>
        <div class="vault-status">
            <span class="vault-status-dot connecting" id="vault-dot"></span>
            <span id="vault-status-text">Awaiting connection...</span>
        </div>
        <div id="vault-content" class="vault-content">
            <div class="vault-empty" style="padding:1rem;">Open the vault to load evidence.</div>
        </div>
        <div class="vault-input-area">
            <div class="vault-input-title">ðŸ“¡ New Transmission</div>
            <textarea id="vault-new-entry" class="vault-textarea" placeholder="Speak your truth (or dictate it)..."></textarea>
            <div class="vault-input-controls">
                <button id="vault-mic-btn" class="vault-btn">ðŸŽ¤ DICTATE</button>
                <select id="vault-tool-select" class="vault-select">
                    <option value="">â€” select tool â€”</option>
                </select>
                <button id="vault-submit-btn" class="vault-btn primary">TRANSMIT</button>
            </div>
            <div style="margin-top:.6rem;text-align:right;">
                <button id="vault-relock-btn" class="vault-btn" style="font-size:.65rem;opacity:.45;">clear token &amp; re-lock</button>
            </div>
        </div>
    </div>
</div>

<script>
// ================================================================
// SUPABASE CONFIG â€” replace these two values after creating your project
// Project URL + anon key: Supabase dashboard â†’ Settings â†’ API
// ================================================================
const SUPABASE_URL  = 'https://cnzsytyjsenvyemmvwzv.supabase.co';
const SUPABASE_ANON = 'sb_publishable__-nh8fWDdRRAGlDqRbaRiQ_uOKlmpnJ';
const SB_ADMIN_LSKEY    = 'sb-admin-key';
const SB_ADMIN_EXPIRY   = 'sb-admin-expiry';
const ADMIN_SESSION_TTL = 30 * 24 * 60 * 60 * 1000;   // 30 days in ms

// â”€â”€ Secure session helpers (localStorage + 30-day expiry) â”€â”€â”€â”€â”€
// localStorage persists across browser restarts (personal machine, sole user).
// A hard 30-day TTL still auto-expires stale tokens.
function getAdminKey() {
    const k = localStorage.getItem(SB_ADMIN_LSKEY);
    const e = localStorage.getItem(SB_ADMIN_EXPIRY);
    if (!k || !e) return null;
    if (Date.now() > parseInt(e, 10)) {
        localStorage.removeItem(SB_ADMIN_LSKEY);
        localStorage.removeItem(SB_ADMIN_EXPIRY);
        _sbAdmin = null;
        return null;
    }
    return k;
}
function setAdminKey(k) {
    localStorage.setItem(SB_ADMIN_LSKEY, k);
    localStorage.setItem(SB_ADMIN_EXPIRY, String(Date.now() + ADMIN_SESSION_TTL));
}
function clearAdminKey() {
    localStorage.removeItem(SB_ADMIN_LSKEY);
    localStorage.removeItem(SB_ADMIN_EXPIRY);
    _sbAdmin = null;
}

let _sb = null, _sbAdmin = null;
function getSb() {
    if (!_sb && !SUPABASE_URL.includes('REPLACE'))
        _sb = supabase.createClient(SUPABASE_URL, SUPABASE_ANON);
    return _sb;
}
function getSbAdmin() {
    if (_sbAdmin) return _sbAdmin;
    const k = getAdminKey();
    if (!k || SUPABASE_URL.includes('REPLACE')) return null;
    _sbAdmin = supabase.createClient(SUPABASE_URL, k);
    return _sbAdmin;
}


// ================================================================
// BOARD FALLBACK â€” used until Supabase is configured
// ================================================================
const BOARD = {
    pin: '1234',   // â† fallback PIN (only used if Supabase not yet configured)
    question: "Should I double down on the Toronto market or expand PFN internationally first?",
    options: [
        { id: 'a', label: 'Option A', text: 'Double down on Toronto â€” own the market first'       },
        { id: 'b', label: 'Option B', text: 'Go international â€” the window is open now'            },
        { id: 'c', label: 'Option C', text: "Both, in parallel â€” the constraint is a story I'm telling myself" },
    ]
};

// ================================================================
// BOOT SEQUENCE
// ================================================================
const BOOT_SEQUENCE = [
    { text: '> initializing neural_sprint_v3.4...',               cls: 'dim',  ms: 180 },
    { text: '> scanning for unoptimized beliefs...  [3 FOUND]',   cls: 'warn', ms: 240 },
    { text: '> migrating ego to cloud (free tier)...              [DEPRECATED]', cls: 'dim', ms: 180 },
    { text: '> consulting Tibetan monks of Silicon Valley...  [QUEUE: 847]', cls: '', ms: 300 },
    { text: '> TRUTH FOUND IN UNDER 60 SESSIONS',                 cls: '',     ms: 480 },
    { text: '> vibes: CALIBRATED  âœ“',                             cls: 'done', ms: 280 },
];

const sleep = ms => new Promise(r => setTimeout(r, ms));

// ================================================================
// DOM REFS
// ================================================================
const transOverlay = document.getElementById('transition-overlay');
const bootLog      = document.getElementById('boot-log');
const bootBar      = document.getElementById('boot-bar');
const bootPct      = document.getElementById('boot-pct');
const container    = document.getElementById('main-container');
const body         = document.body;
const boringMode   = document.getElementById('boring-mode');
const partyMode    = document.getElementById('party-mode');
const exitButton   = document.querySelector('.emergency-exit');

async function runBootSequence() {
    bootLog.innerHTML = ''; bootBar.style.width = '0%'; bootPct.textContent = '';

    const linePromise = (async () => {
        for (const step of BOOT_SEQUENCE) {
            const el = document.createElement('div');
            el.className = 'boot-line' + (step.cls ? ' ' + step.cls : '');
            el.textContent = step.text;
            bootLog.appendChild(el);
            await sleep(20); el.classList.add('show'); await sleep(step.ms);
        }
    })();

    const barPromise = (async () => {
        for (let p = 0; p <= 33; p++) { bootBar.style.width = p + '%'; await sleep(20); }
        await sleep(100); bootBar.style.width = '29%'; await sleep(80);
        for (let p = 29; p <= 69; p++) { bootBar.style.width = p + '%'; await sleep(14); }
        bootPct.textContent = '69% â€” recalibrating vibes...';
        await sleep(820); bootPct.textContent = '';
        for (let p = 69; p <= 100; p++) { bootBar.style.width = p + '%'; await sleep(9); }
    })();

    await Promise.all([linePromise, barPromise]);
    await sleep(300);
}

async function initiatePartyMode() {
    boringMode.style.transition = 'opacity .45s cubic-bezier(.4,0,1,1), transform .45s cubic-bezier(.4,0,1,1)';
    boringMode.style.opacity = '0';
    boringMode.style.transform = 'scale(.97)';
    await sleep(420);

    transOverlay.classList.add('active');
    await sleep(16);
    transOverlay.classList.add('visible');
    await runBootSequence();
    transOverlay.classList.remove('visible');
    await sleep(500);
    transOverlay.classList.remove('active');

    activatePartyMode();
}

function activatePartyMode() {
    haptic([30, 200, 60, 200, 100, 200, 150]); // slow awakening wave
    body.classList.add('party-active');
    container.classList.add('party-active');
    boringMode.style.display = 'none';
    boringMode.style.opacity = '';
    boringMode.style.transform = '';
    partyMode.classList.add('active');
    exitButton.classList.add('active');
    updateStardate();
    updateVaultUI();
    buildBoard();
}

// ================================================================
// EXIT
// ================================================================
exitButton.addEventListener('click', () => {
    partyMode.style.transition = 'opacity .45s cubic-bezier(.4,0,1,1), transform .45s cubic-bezier(.4,0,1,1)';
    partyMode.style.opacity = '0';
    partyMode.style.transform = 'scale(.98)';
    setTimeout(() => {
        body.classList.remove('party-active');
        container.classList.remove('party-active');
        partyMode.classList.remove('active');
        partyMode.style.opacity = '';
        partyMode.style.transform = '';
        boringMode.style.display = 'block';
        boringMode.style.opacity = '0';
        boringMode.style.transform = 'scale(.97)';
        boringMode.style.transition = 'opacity .55s cubic-bezier(.16,1,.3,1), transform .55s cubic-bezier(.16,1,.3,1)';
        requestAnimationFrame(() => requestAnimationFrame(() => {
            boringMode.style.opacity = '1';
            boringMode.style.transform = 'scale(1)';
        }));
        exitButton.classList.remove('active');
    }, 430);
});

// ================================================================
// BOARD OF LIFE DIRECTORS
// ================================================================
async function buildBoard() {
    const useSupa = !!getSb();

    // Load active question from Supabase, fall back to BOARD constant
    let qText = BOARD.question, qOpts = BOARD.options, qId = null;
    if (useSupa) {
        try {
            const { data } = await getSb()
                .from('board_questions').select('*').eq('active', true).single();
            if (data) { qText = data.question; qOpts = data.options; qId = data.id; }
        } catch (_) {}
    }
    document.getElementById('board-q-text').textContent = qText;

    // â”€â”€ PIN gate â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    const pinInput     = document.getElementById('board-pin-input');
    const pinSubmit    = document.getElementById('board-pin-submit');
    const pinError     = document.getElementById('board-pin-error');
    const pinGate      = document.getElementById('board-pin-gate');
    const questionCard = document.getElementById('board-question-card');
    const voteArea     = document.getElementById('board-vote-area');

    function revealVoteUI() {
        pinGate.classList.add('hidden');
        questionCard.style.display = '';
        voteArea.style.display = '';
        pinError.classList.add('hidden');
        // Trigger fade-in on question card
        requestAnimationFrame(() => requestAnimationFrame(() => questionCard.classList.add('revealed')));
        buildVoteButtons();
    }

    async function unlockBoard() {
        const pin = pinInput.value.trim();
        if (!pin) return;
        if (!useSupa) {
            if (pin === BOARD.pin) { revealVoteUI(); }
            else {
                pinError.textContent = 'âš  Incorrect PIN';
                pinError.classList.remove('hidden');
                pinInput.value = '';
                pinInput.classList.add('shake');
                setTimeout(() => pinInput.classList.remove('shake'), 400);
                pinInput.focus();
            }
            return;
        }
        // Validate PIN via rate-limited edge function (no table names in public JS)
        pinSubmit.textContent = '...'; pinSubmit.disabled = true;
        const vpRes = await fetch(`${SUPABASE_URL}/functions/v1/verify-pin`, {
            method: 'POST', headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ pin })
        });
        const { valid } = await (vpRes.ok ? vpRes.json() : Promise.resolve({ valid: false }));
        pinSubmit.textContent = 'Unlock â†—'; pinSubmit.disabled = false;
        if (valid) {
            revealVoteUI();
        } else {
            pinError.textContent = 'âš  Invalid PIN';
            pinError.classList.remove('hidden');
            pinInput.value = '';
            pinInput.classList.add('shake');
            setTimeout(() => pinInput.classList.remove('shake'), 400);
            pinInput.focus();
        }
    }

    pinSubmit.addEventListener('click', unlockBoard);
    pinInput.addEventListener('keydown', e => { if (e.key === 'Enter') unlockBoard(); });

    // â”€â”€ Vote buttons â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    function buildVoteButtons() {
        const optsEl   = document.getElementById('board-options');
        const metaEl   = document.getElementById('board-meta');
        const submitEl = document.getElementById('board-submit');
        optsEl.innerHTML = '';
        if (metaEl) { metaEl.classList.remove('revealed'); metaEl.style.display = 'none'; }
        submitEl.classList.remove('visible', 'animated');

        let selected = null, closenessVal = null, expertiseVal = null;

        function buildDotRating(containerId, labels, onSelect) {
            const container = document.getElementById(containerId);
            if (!container) return;
            container.innerHTML = '';
            const row = document.createElement('div');
            row.className = 'board-dot-row';
            const labelEl = document.createElement('span');
            labelEl.className = 'board-dot-label';
            for (let i = 1; i <= labels.length; i++) {
                const dot = document.createElement('span');
                dot.className = 'board-dot';
                dot.addEventListener('click', () => {
                    row.querySelectorAll('.board-dot').forEach((d, idx) => d.classList.toggle('filled', idx < i));
                    labelEl.textContent = labels[i - 1] || '';
                    onSelect(i);
                });
                row.appendChild(dot);
            }
            row.appendChild(labelEl);
            container.appendChild(row);
        }

        qOpts.forEach(opt => {
            const btn = document.createElement('button');
            btn.className = 'board-btn';
            btn.innerHTML = `
                <span class="board-btn-indicator"></span>
                <span class="board-btn-content">
                    <span class="board-btn-label">${opt.label || 'Option ' + opt.id.toUpperCase()}</span>
                    <span class="board-btn-text">${opt.text}</span>
                </span>`;
            btn.addEventListener('click', () => {
                selected = opt.id;
                optsEl.querySelectorAll('.board-btn').forEach(b => b.classList.remove('selected'));
                btn.classList.add('selected');
                haptic([30]); // ghost tap
                if (metaEl && metaEl.style.display === 'none') {
                    metaEl.style.display = 'block';
                    requestAnimationFrame(() => requestAnimationFrame(() => metaEl.classList.add('revealed')));
                }
                if (!submitEl.classList.contains('visible')) {
                    submitEl.classList.add('visible');
                    requestAnimationFrame(() => requestAnimationFrame(() => submitEl.classList.add('animated')));
                }
            });
            optsEl.appendChild(btn);
        });

        buildDotRating('board-dots-closeness',
            ['Observer', 'Aware', 'Involved', 'Close', 'Deeply affected'],
            v => { closenessVal = v; });
        buildDotRating('board-dots-expertise',
            ['Gut feeling', 'Some context', 'Informed', 'Knowledgeable', 'Expert'],
            v => { expertiseVal = v; });

        submitEl.addEventListener('click', async function() {
            if (!selected) return;
            const choice = qOpts.find(o => o.id === selected);
            const pin    = pinInput.value.trim();
            const justification = (document.getElementById('board-justification')?.value || '').trim() || null;
            this.textContent = 'Submitting...'; this.disabled = true;

            if (useSupa && qId) {
                const { data, error } = await getSb().rpc('cast_vote', {
                    p_pin_code:      pin,
                    p_question_id:   qId,
                    p_choice_id:     selected,
                    p_choice_text:   choice?.text || selected,
                    p_closeness:     closenessVal,
                    p_expertise:     expertiseVal,
                    p_justification: justification
                });
                if (error || !data?.success) {
                    const msg = data?.error === 'already_voted'
                        ? 'âš  You already voted on this question'
                        : data?.error === 'invalid_pin'
                        ? 'âš  Invalid PIN'
                        : 'âš  Something went wrong â€” try again';
                    questionCard.classList.remove('revealed');
                    questionCard.style.display = 'none';
                    voteArea.style.display = 'none';
                    pinGate.classList.remove('hidden');
                    pinError.textContent = msg;
                    pinError.classList.remove('hidden');
                    pinInput.value = '';
                    pinInput.classList.add('shake');
                    setTimeout(() => pinInput.classList.remove('shake'), 400);
                    pinInput.focus();
                    this.textContent = 'Cast vote â†—'; this.disabled = false;
                    return;
                }
            }

            document.getElementById('board-vote-area').classList.add('hidden');
            document.getElementById('board-voted').classList.remove('hidden');
            haptic([60, 120, 60, 120, 80]); // warm double beat
        });
    }
}

// ================================================================
// BORING MODE ADS
// ================================================================

// Contact
document.querySelector('[data-trigger="contact"]').addEventListener('click', function() {
    document.getElementById('contact-form-section').style.display = 'block';
    this.style.display = 'none';
});
document.querySelector('.close-form').addEventListener('click', function() {
    document.getElementById('contact-form-section').style.display = 'none';
    document.querySelector('[data-trigger="contact"]').style.display = 'block';
});
document.getElementById('name-input').addEventListener('input', function() {
    if (this.value.length > 0) document.getElementById('email-field').classList.add('reveal');
});
document.querySelector('#email-field input').addEventListener('input', function() {
    if (this.value.length > 2) document.getElementById('reality-check').classList.add('reveal');
});
document.querySelector('#reality-check select').addEventListener('change', function() {
    document.getElementById('intent-field').classList.add('reveal');
    if (this.value === 'trigger') initiatePartyMode();
});
document.querySelector('#intent-field select').addEventListener('change', function() {
    document.getElementById('budget-field').classList.add('reveal');
});
document.querySelector('#budget-field select').addEventListener('change', function() {
    document.getElementById('captcha-field').classList.add('reveal');
});
document.getElementById('boring-contact-form').addEventListener('submit', function(e) {
    e.preventDefault(); initiatePartyMode();
});

// Domain ad
function gDomain() {
    const pre=['quantum','cyber','meta','neural','crypto','synth','omega','ultra','nano','hyper'];
    const suf=['verse','mind','flux','sync','node','core','matrix','sphere','nexus','cortex'];
    const tld=['.io','.ai','.eth','.meta','.void','.âˆž','.error','.reality'];
    return pre[Math.random()*pre.length|0]+suf[Math.random()*suf.length|0]+tld[Math.random()*tld.length|0];
}
function gPrice() {
    const c=['Souls','BTC','Human Years','Brain Cells','Dreams','Reality Shards','Time Crystals'];
    return `${(Math.random()*9999+1000|0).toLocaleString()} ${c[Math.random()*c.length|0]}`;
}
function gStatus() {
    const s=["Possibly available","SchrÃ¶dinger's domain","Loading...","Ask again later","Reality check pending","DNS machine broke","404 in time-space"];
    return s[Math.random()*s.length|0];
}
function gErr(n) {
    const m=["ERROR: NOT WORTHY","INSUFFICIENT CHAOS","REALITY.EXE FAILED","TRY AGAIN NEVER","*disappointed sigh*","TASK FAILED SUCCESSFULLY"];
    return m[Math.min(n,m.length-1)];
}

document.querySelector('[data-trigger="domain"]').addEventListener('click', function(e) {
    e.preventDefault();
    const ac = this.querySelector('div:last-child');
    let html = `<div style="text-align:left;padding:10px;margin-top:10px;font-size:12px;">
        <div style="font-weight:bold;margin-bottom:8px;letter-spacing:1px;font-family:monospace;">SCANNING QUANTUM REALM FOR D0M41NS...</div>`;
    for (let i = 0; i < 5; i++) {
        html += `<div class="domain-entry" style="display:flex;justify-content:space-between;margin:4px 0;padding:5px;background:#f8f9fa;font-family:monospace;font-size:11px;">
            <span class="domain-name" style="flex-grow:1;">${gDomain()}</span>
            <span class="domain-price" style="color:#666;min-width:110px;text-align:right;">${gPrice()}</span>
            <span class="domain-status" style="font-size:.8em;color:#aaa;margin-left:8px;">${gStatus()}</span>
        </div>`;
    }
    html += `<button class="soul-button" style="width:100%;margin-top:10px;padding:9px;background:#1a0dab;color:white;border:none;cursor:pointer;font-size:12px;font-family:monospace;">EXCHANGE SOUL FOR DOMAIN (NO REFUNDS)</button>
    <div style="font-size:8px;text-align:center;margin-top:4px;font-family:monospace;color:#aaa;">* Soul value may vary. Not valid in this dimension. Previous incarnations affect trade-in value.</div>`;
    ac.innerHTML = html;

    const sb = ac.querySelector('.soul-button');
    let bState = 0, dodgeCount = 0;
    sb.addEventListener('click', function(ev) {
        ev.preventDefault(); ev.stopPropagation();
        if (bState === 0)      { this.style.width='90%'; this.innerHTML='N1C3 TRY H4X0R... ï¼ˆâ•¯Â°â–¡Â°ï¼‰â•¯ï¸µ â”»â”â”»'; this.style.background='#ff4444'; bState++; }
        else if (bState === 1) { this.style.width='80%'; this.innerHTML='PERSISTENCE DETECTED... à² _à² '; this.style.background='#ff6666'; this.style.transform='rotate(2deg)'; bState++; }
        else                   { this.innerHTML='FINE... à¼¼ ã¤ â—•_â—• à¼½ã¤'; setTimeout(initiatePartyMode, 500); }
    });
    sb.addEventListener('mouseover', function() {
        dodgeCount++;
        if (dodgeCount > 2 && bState < 2) {
            const pr = ac.getBoundingClientRect(), sr = this.getBoundingClientRect();
            this.style.position = 'absolute';
            this.style.left = Math.max(0, Math.min(Math.random() * (pr.width - sr.width), pr.width - sr.width)) + 'px';
            this.style.top  = Math.max(0, Math.min(Math.random() * (pr.height - sr.height), pr.height - sr.height)) + 'px';
            this.style.transform = `rotate(${Math.sin(dodgeCount) * 8}deg)`;
        }
    });
    setInterval(() => {
        document.querySelectorAll('.domain-entry').forEach(entry => {
            if (Math.random() > .85) { const p = entry.querySelector('.domain-price'); p.textContent = gPrice(); p.style.transform = 'scale(1.08)'; setTimeout(() => p.style.transform = 'scale(1)', 180); }
            if (Math.random() > .92) entry.querySelector('.domain-status').textContent = gStatus();
        });
    }, 2200);
});

// Hosting ad
document.querySelector('[data-trigger="hosting"]').addEventListener('click', function(e) {
    e.preventDefault();
    const ac = this.querySelector('div:last-child');
    ac.innerHTML = `<div style="padding:14px 0;font-size:13px;">
        <div style="font-weight:bold;margin-bottom:10px;color:#1a0dab;">Reality Hosting Assessment Protocol</div>
        <div style="color:#888;font-size:11px;margin-bottom:10px;">* Your choices will determine your fate</div>
        <label style="font-size:12px;">Technical Expertise Level:</label>
        <select class="boring-input" data-type="expertise" style="margin-top:5px;">
            <option value="">Select your level of delusion...</option>
            <option value="noob">I once pressed F12 and felt like a hacker</option>
            <option value="css">I can center a div (sometimes)</option>
            <option value="stackoverflow">Stack Overflow is my homepage</option>
            <option value="trigger">ALL GLORY TO THE HYPNOTOAD</option>
        </select>
        <div class="hosting-plans" style="margin-top:12px;"></div>
    </div>`;

    const planData = {
        noob: [
            { title:"TRAINING WHEELS REALITY", price:"$4.99/confusion", features:["Stack Overflow Premium","Panic Button Support","Auto-save (60% of the time)","Undo Life Choices"] },
            { title:"FAKE IT TILL YOU MAKE IT", price:"$âˆž/imposter", features:["Corporate Buzzword Generator","Meeting Simulator","LinkedIn Auto-Bragger","Confidence Synthesizer"], hi:true },
        ],
        css: [
            { title:"FLEXBOX NIGHTMARE", price:"margin: auto;", features:["!important Priority Support","Z-index: 999999","Emergency CSS Reset"] },
            { title:"ENTERPRISE CSS SOLUTION", price:"float: none;", features:["Legacy IE Support","Table-based Layouts","Bootstrap 2.0"], hi:true },
        ],
        stackoverflow: [
            { title:"COPY-PASTE STARTER PACK", price:"15 rep/month", features:["Auto-Copy Best Answer","Duplicate Question Finder","Actually Marked as Answer"] },
            { title:"ENTERPRISE OVERFLOW", price:"Closed as Duplicate", features:["Legacy Code Generator","Technical Debt Maximizer","Agile Waterfall Hybrid"], hi:true },
        ]
    };

    ac.querySelector('[data-type="expertise"]').addEventListener('change', function() {
        if (this.value === 'trigger') { initiatePartyMode(); return; }
        const plans = planData[this.value]; if (!plans) return;
        const pc = ac.querySelector('.hosting-plans');
        pc.innerHTML = `<div style="display:grid;grid-template-columns:repeat(${plans.length},1fr);gap:8px;">` +
            plans.map(p => `<div style="border:1px solid ${p.hi?'#1a0dab':'#ddd'};padding:10px;text-align:center;font-size:11px;">
                <div style="font-weight:bold;font-size:10px;margin-bottom:6px;">${p.title}</div>
                <div style="font-size:20px;margin:8px 0;font-family:monospace;">${p.price}</div>
                <ul style="text-align:left;margin:8px 0;">${p.features.map(f=>`<li>${f}</li>`).join('')}</ul>
                <button class="plan-btn boring-submit" style="width:100%;font-size:10px;padding:6px;">${p.hi?'MORTGAGE YOUR SOUL':'EMBRACE MEDIOCRITY'}</button>
            </div>`).join('') + '</div>';
        let cc = 0;
        pc.querySelectorAll('.plan-btn').forEach(btn => {
            btn.addEventListener('click', function(ev) {
                ev.preventDefault(); cc++;
                if (cc > 3) { initiatePartyMode(); return; }
                this.textContent = gErr(cc); this.style.background = '#ff4444';
            });
        });
    });
});

// ================================================================
// ORACLE
// ================================================================
const ORACLE_RESPONSES = [
    "The obstacle is the path. Also you're probably just hungry.",
    "You already know. You're waiting for permission you won't need.",
    "Stop optimizing the wrong variable.",
    "Your future self is watching this moment. They look entertained.",
    "The version of this that actually works looks nothing like what you're picturing.",
    "This, too, will become a good story.",
    "You need less advice and more momentum.",
    "Execute. Adjust. Repeat. The plan is a fiction.",
    "The gap between knowing and doing is where most lives are lived.",
    "The thing you keep postponing IS the work.",
    "High ceiling, low floor. That's you.",
    "The timing was never the problem.",
    "You're asking the oracle but you need the mirror.",
    "Someone who disagrees with you is more right than you'd like.",
    "The answer you seek is already in your second-best idea.",
    "Your intuition has been correct about this since the beginning.",
    "This decision will matter to you for exactly 4.7 years.",
    "You're not behind. You're a late-season pickup with championship potential.",
    "Whatever you're building, make it weirder.",
    "The people who matter will not need you to explain yourself.",
    "Comfort is a symptom, not a destination.",
    "The second wind always comes. It's just bad at timing.",
    "Error 404: Certainty not found. Proceeding anyway is the correct response.",
    "You have more runway than you think and less time than you're acting like.",
    "The version of you that figures this out is already on their way.",
    "There is no hack. There's just the thing, done with more care.",
    "Your nervous system is not broken. It's calibrating.",
    "One person's opinion about your life is a data point. Treat it accordingly.",
    "Whatever room you walk into, you belong there more than you think.",
    "Progress and peace are not in conflict. You were misinformed.",
    "The thing that scares you slightly is probably the thing.",
    "It's not complicated. You're just not ready to make it simple.",
    "Everyone is figuring it out in real time. Some are just quieter about it.",
    "The constraint you keep bumping into is actually a door.",
    "Trust the edit. Kill the darlings. Ship it anyway.",
    "More reps. Same compound movement. That's the whole strategy.",
    "The question behind the question is usually more interesting.",
    "Your standards are not the problem. Your timeline is.",
    "The person you're being in private is building the person everyone else sees.",
    "You will be misunderstood. Build something worth misunderstanding.",
    "SYSTEM ALERT: Overthinking detected. Rebooting to first principles.",
    "The oracle consulted its models and concluded: just do it, obviously.",
    "WARNING: High concentration of unacted-upon potential detected. Source: you.",
    "CALIBRATION COMPLETE. You're more ready than the feeling of ready.",
    "Signal acquired. Path continues. Visibility: 50 feet. That's enough.",
    "Kernel panic avoided. Resume operations. One step at a time.",
    "The forest disappears. The trees remain. Your feet already know the way.",
    "Whatever you just thought of â€” that one â€” yes.",
    "You've been the bottleneck. You're also the only fix.",
    "The version of this that fails is more useful than the version that waits.",
];
// â”€â”€ Haptics â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// Gentle, organic â€” not notifications. iOS ignores this gracefully.
function haptic(pattern) { if (navigator.vibrate) navigator.vibrate(pattern); }

const ORACLE_SCANS = [
    'CALIBRATING RESONANCE...','CROSS-REFERENCING REGRETS...',
    'CONSULTING THE ANCESTORS...','RUNNING ENTROPY MODELS...',
    'SUPPRESSING NOISE...','TRIANGULATING TRUTH...',
    'DISSOLVING EGO INTERFERENCE...','ALIGNING PROBABILITY FIELDS...',
];
let _oracleUsed = [], _oracleConsults = 0, _oracleConnectTriggered = false;

const CONNECT_KEYWORDS = ['you','real','talk','call','meet','connect','anthony','who are','reach','contact','person','human','behind','actual','genuinely','really','anyone'];
const CONNECT_RESPONSES = [
    "SIGNAL DETECTED. You're not asking the oracle â€” you're asking the person behind it. Leave your name and how to reach you.",
    "ANOMALY: this question exceeds oracle parameters. Routing to human operator. Leave your coordinates.",
    "The oracle knows when it's being looked through. Some questions are mine to answer directly.",
    "You keep coming back. That means something. Leave your name and best way to reach you.",
];

function getOracleResponse() {
    if (_oracleUsed.length >= ORACLE_RESPONSES.length) _oracleUsed = [];
    const pool = ORACLE_RESPONSES.filter((_, i) => !_oracleUsed.includes(i));
    const pick = pool[Math.floor(Math.random() * pool.length)];
    _oracleUsed.push(ORACLE_RESPONSES.indexOf(pick));
    return pick;
}
function shouldConnect(question) {
    if (_oracleConnectTriggered) return false;
    const q = question.toLowerCase();
    if (CONNECT_KEYWORDS.some(k => q.includes(k))) return true;
    if (_oracleConsults >= 3) return true;
    return false;
}

document.getElementById('oracle-ask').addEventListener('click', async () => {
    const btn        = document.getElementById('oracle-ask');
    const responseEl = document.getElementById('oracle-response');
    const scanEl     = document.getElementById('oracle-scanning');
    const answerEl   = document.getElementById('oracle-answer');
    const connectEl  = document.getElementById('oracle-connect');
    const question   = document.getElementById('oracle-input').value.trim();

    btn.disabled = true;
    _oracleConsults++;
    const triggerConnect = shouldConnect(question);

    // Reset state
    answerEl.classList.remove('revealed');
    connectEl.classList.remove('revealed');
    responseEl.classList.remove('revealed');
    answerEl.textContent = '';

    requestAnimationFrame(() => requestAnimationFrame(() => responseEl.classList.add('revealed')));

    // Scan â€” longer + different messages if about to connect
    const scans = triggerConnect
        ? ['CROSS-REFERENCING SIGNAL...','IDENTIFYING SOURCE...','BYPASSING ORACLE LAYER...','ROUTING TO HUMAN...']
        : ORACLE_SCANS;
    haptic([80, 400, 80, 400, 80]); // three deep slow pulses while thinking
    let si = 0;
    const scanTick = setInterval(() => {
        scanEl.innerHTML = scans[si % scans.length] + '<span class="oracle-scan-bar"></span>';
        si++;
    }, triggerConnect ? 400 : 310);

    await new Promise(r => setTimeout(r, triggerConnect ? 3000 : 2500));
    clearInterval(scanTick);
    scanEl.innerHTML = '';

    if (triggerConnect) {
        _oracleConnectTriggered = true;
        haptic([100, 200, 150, 200, 300]); // unmistakably different â€” something opened
        const resp = _oracleConsults >= 4 && !CONNECT_KEYWORDS.some(k => question.toLowerCase().includes(k))
            ? CONNECT_RESPONSES[3]
            : CONNECT_RESPONSES[Math.floor(Math.random() * 3)];
        answerEl.textContent = resp;
        requestAnimationFrame(() => requestAnimationFrame(() => {
            answerEl.classList.add('revealed');
            setTimeout(() => connectEl.classList.add('revealed'), 600);
        }));
        btn.style.display = 'none';
    } else {
        haptic([40, 150, 80]); // soft landing
        answerEl.textContent = getOracleResponse();
        requestAnimationFrame(() => requestAnimationFrame(() => answerEl.classList.add('revealed')));
    }
    btn.disabled = false;
});

document.getElementById('oracle-input').addEventListener('keydown', e => {
    if (e.key === 'Enter') document.getElementById('oracle-ask').click();
});

document.getElementById('oc-submit').addEventListener('click', async () => {
    const name    = document.getElementById('oc-name').value.trim();
    const contact = document.getElementById('oc-contact').value.trim();
    if (!name || !contact) {
        (!name ? document.getElementById('oc-name') : document.getElementById('oc-contact')).focus();
        return;
    }
    const submitBtn = document.getElementById('oc-submit');
    submitBtn.disabled = true; submitBtn.textContent = 'Sending...';
    const sb = getSb();
    if (sb) {
        await sb.from('call_requests').insert({
            name,
            contact,
            trigger_question: document.getElementById('oracle-input').value.trim() || null
        });
    }
    submitBtn.style.display = 'none';
    haptic([100, 150, 250]); // intentional, ascending â€” something real just happened
    const sent = document.getElementById('oc-sent');
    sent.style.display = 'block';
    requestAnimationFrame(() => requestAnimationFrame(() => sent.classList.add('revealed')));
});

// ================================================================
// MISC
// ================================================================
document.getElementById('sneak-attack').addEventListener('click', initiatePartyMode);

document.addEventListener('keydown', e => {
    if (e.key === 'Escape') {
        const ao = document.getElementById('admin-overlay');
        const vo = document.getElementById('vault-overlay');
        if (ao.classList.contains('active')) closeOverlay('admin-overlay');
        else if (vo.classList.contains('active')) closeOverlay('vault-overlay');
        else if (exitButton.classList.contains('active')) exitButton.click();
    }
});

// #board shortcut â€” skip straight to party mode, scroll to board
if (window.location.hash === '#board') {
    document.addEventListener('DOMContentLoaded', () => {
        setTimeout(() => {
            activatePartyMode();
            setTimeout(() => document.querySelector('.board-section')?.scrollIntoView({ behavior:'smooth' }), 500);
        }, 200);
    });
}

function updateStardate() {
    const el = document.getElementById('stardate');
    if (el) el.textContent = `${new Date().getFullYear()+376}.${Math.random()*9|0}`;
}
updateStardate();
setInterval(updateStardate, 5000);

// ================================================================
// PROOF VAULT
// ================================================================
const VAULT_SSE_URL   = 'https://proof-vault-mcp.x-25e.workers.dev/sse';
const VAULT_TOKEN_KEY = 'proof-vault-gh-token';

(function checkVaultUnlock() {
    const hash = window.location.hash;
    if (hash.startsWith('#vault-')) {
        const token = decodeURIComponent(hash.slice(7));
        if (token) { localStorage.setItem(VAULT_TOKEN_KEY, token); history.replaceState(null, '', window.location.pathname + window.location.search); }
    }
    if (hash.startsWith('#sb-admin-')) {
        const key = decodeURIComponent(hash.slice(10));
        if (key) { setAdminKey(key); history.replaceState(null, '', window.location.pathname + window.location.search); }
    }
    updateVaultUI();
})();

function getVaultToken() { return localStorage.getItem(VAULT_TOKEN_KEY); }
function updateVaultUI() {
    const token=getVaultToken(), fb=document.getElementById('vault-float-btn'), lh=document.getElementById('vault-locked-hint'), uh=document.getElementById('vault-unlocked-hint');
    if(fb) fb.style.display=token?'block':'none';
    if(lh) lh.style.display=token?'none':'inline';
    if(uh) uh.style.display=token?'inline':'none';
    // Show admin button whenever service key is stored
    const ab=document.getElementById('admin-float-btn');
    if(ab) ab.style.display=getAdminKey()?'block':'none';
}

class VaultMCPClient {
    constructor(u,t){this.sseUrl=u;this.token=t;this.messageEndpoint=null;this.pending={};this.nextId=1;this._onReady=null;}
    connect(){return new Promise((r,j)=>{this._onReady=r;this._startSSE(j);});}
    async _startSSE(onError){
        try{
            const resp=await fetch(this.sseUrl,{headers:{'Authorization':`Bearer ${this.token}`,'Accept':'text/event-stream','Cache-Control':'no-cache'}});
            if(!resp.ok){onError(new Error(`Auth failed (${resp.status})`));return;}
            const reader=resp.body.getReader(),decoder=new TextDecoder();
            let buf='',etype='',edata='';
            while(true){const{done,value}=await reader.read();if(done)break;buf+=decoder.decode(value,{stream:true});const lines=buf.split('\n');buf=lines.pop();for(const line of lines){if(line.startsWith('event:'))etype=line.slice(6).trim();else if(line.startsWith('data:'))edata=(edata?edata+'\n':'')+line.slice(5).trim();else if(line===''){this._handleEvent(etype,edata);etype='';edata='';}}}
        }catch(err){onError(err);}
    }
    _handleEvent(type,data){
        if(type==='endpoint'){try{this.messageEndpoint=new URL(data,this.sseUrl).toString();}catch{this.messageEndpoint=data;}if(this._onReady){this._onReady(this);this._onReady=null;}}
        else if(type==='message'||!type){try{const msg=JSON.parse(data);if(msg.id!==undefined&&this.pending[msg.id]){const{resolve,reject,timeout}=this.pending[msg.id];clearTimeout(timeout);delete this.pending[msg.id];msg.error?reject(new Error(msg.error.message||JSON.stringify(msg.error))):resolve(msg.result);}}catch(_){}}
    }
    async _request(method,params={}){
        if(!this.messageEndpoint)throw new Error('Not connected');
        const id=this.nextId++;
        const promise=new Promise((resolve,reject)=>{const timeout=setTimeout(()=>{if(this.pending[id]){delete this.pending[id];reject(new Error(`Timeout: ${method}`));}},15000);this.pending[id]={resolve,reject,timeout};});
        const resp=await fetch(this.messageEndpoint,{method:'POST',headers:{'Content-Type':'application/json','Authorization':`Bearer ${this.token}`},body:JSON.stringify({jsonrpc:'2.0',id,method,params})});
        if(!resp.ok&&resp.status!==202)throw new Error(`POST failed: ${resp.status}`);
        return promise;
    }
    initialize(){return this._request('initialize',{protocolVersion:'2024-11-05',capabilities:{},clientInfo:{name:'machu.la',version:'3.0'}});}
    listTools(){return this._request('tools/list',{});}
    callTool(name,args={}){return this._request('tools/call',{name,arguments:args});}
}

let _vaultClient=null;
function escHtml(t){const d=document.createElement('div');d.appendChild(document.createTextNode(t));return d.innerHTML;}

async function openVault(){
    const token=getVaultToken();
    if(!token){alert('Vault locked.\n\nVisit: machu.la/#vault-YOUR_GITHUB_TOKEN to unlock.');return;}
    const vo=document.getElementById('vault-overlay'),ce=document.getElementById('vault-content');
    openOverlay('vault-overlay');setVaultStatus('ESTABLISHING NEURAL LINK...','connecting');
    ce.innerHTML='<div class="vault-loading" style="padding:1rem;">âŸ³ Connecting...</div>';
    try{
        const client=new VaultMCPClient(VAULT_SSE_URL,token);
        setVaultStatus('AWAITING ENDPOINT...','connecting');await client.connect();
        await client.initialize();
        const tr=await client.listTools();const tools=tr?.tools||[];
        setVaultStatus(`VAULT OPEN â€” ${tools.length} tool${tools.length!==1?'s':''} available`,'ok');
        _vaultClient=client;
        const sel=document.getElementById('vault-tool-select');sel.innerHTML='<option value="">â€” select tool â€”</option>';
        tools.forEach(t=>{const o=document.createElement('option');o.value=t.name;o.textContent=`${t.name}${t.description?' â€” '+t.description:''}`;sel.appendChild(o);});
        ce.innerHTML='';
        const rTools=tools.filter(t=>{const n=t.name.toLowerCase(),req=t.inputSchema?.required||[];return req.length===0||['list','get','all','read','search'].some(k=>n.includes(k));});
        if(!rTools.length)ce.innerHTML='<div class="vault-empty" style="padding:1rem;">Vault connected. Use the tool selector below.</div>';
        for(const tool of rTools.slice(0,6)){
            const sec=document.createElement('div');sec.className='vault-section';
            sec.innerHTML=`<div class="vault-section-header"><span class="vault-section-name">${escHtml(tool.name)}</span><span class="vault-section-desc">${escHtml(tool.description||'')}</span></div><div class="vault-section-content" id="vr-${escHtml(tool.name)}"><span class="vault-loading">Loading...</span></div>`;
            ce.appendChild(sec);
            client.callTool(tool.name,{}).then(r=>{const el=document.getElementById(`vr-${tool.name}`);if(el)el.innerHTML=renderVaultResult(r);}).catch(err=>{const el=document.getElementById(`vr-${tool.name}`);if(el)el.innerHTML=`<span class="vault-error">Error: ${escHtml(err.message)}</span>`;});
        }
    }catch(err){setVaultStatus('CONNECTION FAILED','error');document.getElementById('vault-content').innerHTML=`<div class="vault-error-state"><div style="font-size:1.1rem;margin-bottom:.8rem;">âš ï¸ VAULT ACCESS DENIED</div><div style="font-size:.78rem;margin-bottom:.8rem;">${escHtml(err.message)}</div><div style="font-size:.68rem;color:#553333;">Re-unlock: <code>machu.la/#vault-[NEW_TOKEN]</code></div></div>`;}
}

function setVaultStatus(msg,state){
    const t=document.getElementById('vault-status-text'),d=document.getElementById('vault-dot');
    if(t)t.textContent=msg;
    if(d){d.className='vault-status-dot';if(state==='error')d.classList.add('error');else if(state==='connecting')d.classList.add('connecting');}
}

function renderVaultResult(result){
    if(!result)return'<span class="vault-empty">No data returned</span>';
    let content=result;
    if(result.content&&Array.isArray(result.content)){const texts=result.content.filter(c=>c.type==='text').map(c=>c.text);if(texts.length){try{content=JSON.parse(texts.join(''));}catch{return`<div class="vault-text-result">${texts.map(t=>`<div class="vault-entry"><div class="vault-entry-main">${escHtml(t)}</div></div>`).join('')}</div>`;}}}
    if(content&&typeof content==='object'){for(const key of['records','data','entries','items','results','notes','documents']){if(content[key]&&Array.isArray(content[key])){content=content[key];break;}}}
    if(Array.isArray(content)){if(!content.length)return'<span class="vault-empty">No records found</span>';return`<div class="vault-records">${content.map(r=>renderVaultRecord(r)).join('')}</div>`;}
    if(typeof content==='object'&&content!==null)return`<div class="vault-records">${renderVaultRecord(content)}</div>`;
    return`<div class="vault-text-result">${escHtml(String(content))}</div>`;
}

function renderVaultRecord(rec){
    if(typeof rec==='string')return`<div class="vault-entry"><div class="vault-entry-main">${escHtml(rec)}</div></div>`;
    if(typeof rec!=='object'||rec===null)return`<div class="vault-entry"><div class="vault-entry-main">${escHtml(String(rec))}</div></div>`;
    const main=['title','name','content','text','note','body','entry','description','message','proof'].map(f=>rec[f]).find(Boolean);
    const date=['date','created','created_at','createdTime','timestamp','updated_at'].map(f=>rec[f]).find(Boolean);
    const tags=['tags','tag','category','type','status','labels'].map(f=>rec[f]).find(Boolean);
    if(!main)return`<div class="vault-entry">${Object.entries(rec).slice(0,8).map(([k,v])=>`<div><span style="color:#553333;">${escHtml(k)}:</span> <span style="color:#ffaaaa;">${escHtml(typeof v==='object'?JSON.stringify(v):String(v))}</span></div>`).join('')}</div>`;
    return`<div class="vault-entry"><div class="vault-entry-main">${escHtml(String(main))}</div>${date?`<div class="vault-entry-date">â± ${escHtml(String(date))}</div>`:''} ${tags?`<div class="vault-entry-tags">${(Array.isArray(tags)?tags:[tags]).map(t=>`<span class="vault-tag">${escHtml(String(t))}</span>`).join('')}</div>`:''}</div>`;
}

document.getElementById('vault-float-btn').addEventListener('click',e=>{e.preventDefault();openVault();});
document.getElementById('vault-close').addEventListener('click',()=>closeOverlay('vault-overlay'));
document.getElementById('vault-relock-btn').addEventListener('click',()=>{if(confirm('Clear vault token?')){localStorage.removeItem(VAULT_TOKEN_KEY);updateVaultUI();closeOverlay('vault-overlay');}});
document.getElementById('vault-submit-btn').addEventListener('click',async function(){
    if(!_vaultClient){alert('Open the vault first.');return;}
    const toolName=document.getElementById('vault-tool-select').value,text=document.getElementById('vault-new-entry').value.trim();
    if(!toolName){alert('Select a tool first.');return;}if(!text){alert('Enter some content first.');return;}
    this.textContent='TRANSMITTING...';this.disabled=true;
    try{await _vaultClient.callTool(toolName,{content:text,text,note:text,entry:text,body:text,message:text});document.getElementById('vault-new-entry').value='';this.textContent='âœ“ TRANSMITTED';setTimeout(()=>{this.textContent='TRANSMIT';this.disabled=false;},2000);}
    catch(err){this.textContent=`âœ— ${err.message.slice(0,28)}`;setTimeout(()=>{this.textContent='TRANSMIT';this.disabled=false;},3000);}
});

// ================================================================
// ADMIN PANEL
// ================================================================
function closeOverlay(id) {
    const el = document.getElementById(id);
    el.classList.remove('shown');
    setTimeout(() => el.classList.remove('active'), 420);
}
function openOverlay(id) {
    const el = document.getElementById(id);
    el.classList.add('active');
    requestAnimationFrame(() => requestAnimationFrame(() => el.classList.add('shown')));
}

async function openAdmin() {
    openOverlay('admin-overlay');
    const key = getAdminKey();
    document.getElementById('admin-key-gate').style.display = key ? 'none' : 'block';
    document.getElementById('admin-main').style.display     = key ? 'block' : 'none';
    if (!key) return;
    if (!window._adminUILoaded) {
        // Fetch admin panel code from protected edge function.
        // Table names, function URLs, and all admin logic stay server-side until after auth.
        try {
            const res = await fetch(`${SUPABASE_URL}/functions/v1/admin-ui`, {
                headers: { 'Authorization': `Bearer ${key}` }
            });
            if (!res.ok) {
                clearAdminKey();
                document.getElementById('admin-key-gate').style.display = 'block';
                document.getElementById('admin-main').style.display = 'none';
                return;
            }
            const js = await res.text();
            const script = document.createElement('script');
            script.textContent = js;
            document.head.appendChild(script);
            window._adminUILoaded = true;
        } catch (e) { console.error('Failed to load admin UI:', e); }
    } else if (typeof loadAdminTab === 'function') {
        await loadAdminTab('question');
    }
}

document.getElementById('admin-float-btn').addEventListener('click', openAdmin);
document.getElementById('admin-close').addEventListener('click', () => closeOverlay('admin-overlay'));


(function initSpeech(){
    const SR=window.SpeechRecognition||window.webkitSpeechRecognition,micBtn=document.getElementById('vault-mic-btn'),textarea=document.getElementById('vault-new-entry');
    if(!SR){if(micBtn){micBtn.textContent='ðŸŽ¤ (n/a)';micBtn.disabled=true;}return;}
    const sr=new SR();sr.continuous=true;sr.interimResults=true;sr.lang='en-US';
    let isRec=false,finalText='';
    sr.onresult=e=>{let interim='';for(let i=e.resultIndex;i<e.results.length;i++){if(e.results[i].isFinal)finalText+=e.results[i][0].transcript;else interim+=e.results[i][0].transcript;}textarea.value=finalText+(interim?` [${interim}]`:'');};
    sr.onend=()=>{isRec=false;micBtn.textContent='ðŸŽ¤ DICTATE';micBtn.classList.remove('recording');textarea.value=textarea.value.replace(/\s*\[.*?\]/g,'').trim();};
    micBtn.addEventListener('click',()=>{if(isRec){sr.stop();}else{finalText=textarea.value;sr.start();isRec=true;micBtn.textContent='â¹ STOP';micBtn.classList.add('recording');}});
})();
</script>
</body>
</html>
