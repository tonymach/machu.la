<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>machu.la</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }

        body {
            font-family: Arial, sans-serif;
            line-height: 1.6;
            background: #f0ede8;
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 1rem;
            transition: background 0.8s ease;
        }

        .container {
            width: 90%; max-width: 720px;
            margin: 0 auto;
            background: white;
            box-shadow: 0 1px 4px rgba(0,0,0,0.12);
            position: relative;
            overflow: visible;
            transition: max-width 0.8s cubic-bezier(.16,1,.3,1),
                        border 0.5s ease,
                        box-shadow 0.7s ease,
                        background 0.5s ease;
        }

        /* ‚îÄ‚îÄ‚îÄ BORING MODE ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ */
        .boring-mode { position: relative; overflow: hidden; transition: opacity .4s ease; }

        .boring-shimmer {
            position: absolute; top: 0; left: 0;
            width: 45%; height: 100%;
            background: linear-gradient(
                108deg,
                transparent 30%,
                rgba(255, 215, 0, 0.07) 50%,
                rgba(255, 215, 0, 0.04) 56%,
                transparent 70%
            );
            transform: translateX(-220%);
            animation: card-sheen 14s ease-in-out infinite;
            pointer-events: none; z-index: 10;
        }
        @keyframes card-sheen {
            0%, 74%  { transform: translateX(-220%); }
            86%      { transform: translateX(420%);  }
            100%     { transform: translateX(420%);  }
        }

        .boring-header {
            padding: 28px 30px 22px;
            text-align: center;
            border-bottom: 1px solid #eee;
            background: white;
        }
        .boring-domain { font-size: 22px; color: #222; margin-bottom: 6px; letter-spacing: -0.5px; }
        .boring-tagline { color: #888; font-size: 13px; }

        .boring-content { padding: 24px 28px 10px; }

        .boring-ad {
            border: 1px solid #e0ddd9; padding: 18px 20px; margin: 10px 0;
            text-align: left; cursor: pointer;
            transition: background .2s ease, border-color .2s ease, transform .15s ease;
            position: relative; overflow: hidden; border-radius: 3px;
        }
        .boring-ad:hover { background: #faf9f7; border-color: #b8b4af; transform: translateX(2px); }
        .ad-label { font-size: 10px; text-transform: uppercase; letter-spacing: 1.5px; color: #bbb; margin-bottom: 4px; }
        .ad-title { color: #1a0dab; font-size: 14px; margin-bottom: 3px; }
        .ad-url   { color: #006621; font-size: 11px; margin-bottom: 5px; }
        .ad-body  { color: #4a4a4a; font-size: 13px; line-height: 1.5; }

        .boring-divider { border: none; border-top: 1px dashed #e5e2de; margin: 16px 0; }

        .boring-footer {
            text-align: center; padding: 16px 20px 18px;
            border-top: 1px solid #eee; color: #aaa; font-size: 11px;
            background: #faf9f7;
        }

        .boring-contact-form {
            border: 1px solid #e0ddd9; border-radius: 3px;
            padding: 20px; margin: 12px 0; background: white;
        }
        .boring-input {
            width: 100%; padding: 8px 10px; margin: 5px 0 14px;
            border: 1px solid #ddd; border-radius: 3px; font-size: 13px;
        }
        .boring-submit {
            background: #1a73e8; color: white; border: none;
            padding: 9px 18px; border-radius: 3px; cursor: pointer; font-size: 13px;
        }
        .form-group { margin-bottom: 12px; font-size: 13px; color: #444; }
        .hidden { display: none !important; }
        .reveal { display: block !important; }

        /* ‚îÄ‚îÄ‚îÄ TRANSITION ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ */
        .transition-overlay {
            display: none; position: fixed; inset: 0;
            background: #000; z-index: 10000;
            font-family: monospace; padding: 2rem;
            opacity: 0; transition: opacity .6s ease;
            justify-content: center; align-items: center;
            flex-direction: column;
        }
        .transition-overlay.active  { display: flex; }
        .transition-overlay.visible { opacity: 1; }

        .boot-log { width: min(500px, 90vw); }
        .boot-line {
            font-size: .8rem; color: #0f0; padding: .15rem 0;
            opacity: 0; transform: translateY(4px);
            transition: opacity .2s ease, transform .2s ease;
        }
        .boot-line.show  { opacity: 1; transform: translateY(0); }
        .boot-line.dim   { color: #2a6e2a; }
        .boot-line.warn  { color: #FFD700; }
        .boot-line.done  { color: #4ADE80; }
        .boot-bar-wrap {
            width: min(500px, 90vw); margin-top: 1.4rem;
            background: #050505; border: 1px solid #1a3a1a; height: 2px; overflow: hidden;
        }
        .boot-bar { height: 100%; width: 0%; background: #0f0; box-shadow: 0 0 6px #0f0; }
        .boot-pct { margin-top: .5rem; font-size: .65rem; color: #2a6e2a; letter-spacing: 2px; min-height: 1rem; }

        /* ‚îÄ‚îÄ‚îÄ ANIMATIONS ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ */
        @keyframes bounce   { 0%,100%{transform:translateY(0)} 50%{transform:translateY(-8px)} }
        @keyframes pulse    { 0%,100%{opacity:1} 50%{opacity:.65} }
        @keyframes fadeUp   { from{opacity:0;transform:translateY(16px)} to{opacity:1;transform:translateY(0)} }
        @keyframes glitch   { 0%{transform:translate(0)} 20%{transform:translate(-2px,2px)} 40%{transform:translate(-2px,-2px)} 60%{transform:translate(2px,2px)} 80%{transform:translate(2px,-2px)} 100%{transform:translate(0)} }
        @keyframes rainbow  { 0%{color:red} 17%{color:orange} 34%{color:yellow} 50%{color:lime} 67%{color:cyan} 84%{color:magenta} 100%{color:red} }
        @keyframes psychedelic {
            0%,100%{filter:hue-rotate(0deg) saturate(100%)}
            25%{filter:hue-rotate(90deg) saturate(140%)}
            50%{filter:hue-rotate(180deg) saturate(180%)}
            75%{filter:hue-rotate(270deg) saturate(140%)}
        }

        /* ‚îÄ‚îÄ‚îÄ PARTY MODE ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ */
        .party-mode { display: none; opacity: 0; transition: opacity .6s ease; }
        .party-mode.active { display: block; opacity: 1; }

        body.party-active {
            background:
                radial-gradient(circle at 20% 50%, rgba(138,43,226,.25) 0%, transparent 50%),
                radial-gradient(circle at 80% 50%, rgba(75,0,130,.25) 0%, transparent 50%),
                radial-gradient(circle at 50% 20%, rgba(255,20,147,.2) 0%, transparent 50%),
                radial-gradient(circle at 50% 80%, rgba(255,215,0,.2) 0%, transparent 50%),
                repeating-conic-gradient(from 0deg at 50% 50%,
                    #FF1493 0deg, #9400D3 60deg, #4B0082 120deg,
                    #0000FF 180deg, #00FF00 240deg, #FFFF00 300deg, #FF1493 360deg);
            animation: psychedelic 22s ease-in-out infinite;
        }
        .container.party-active {
            max-width: 820px;
            border: 6px solid #FFD700;
            box-shadow: 0 0 50px rgba(255,215,0,.12), 0 0 100px rgba(255,0,255,.06);
            background: #030303;
        }

        .party-mode.active .party-header   { animation: fadeUp .5s ease both; }
        .party-mode.active .board-section  { animation: fadeUp .5s .12s ease both; }
        .party-mode.active .easter-section { animation: fadeUp .5s .26s ease both; }
        .party-mode.active .poem-section   { animation: fadeUp .5s .40s ease both; }
        .party-mode.active .vault-hint     { animation: fadeUp .5s .54s ease both; }

        .party-header {
            padding: 2rem 2.5rem; text-align: center;
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 50%, #0f3460 100%);
            border-bottom: 5px solid #FFD700;
        }
        .party-domain {
            font-size: 3.5rem; font-weight: bold;
            font-family: 'Comic Sans MS', cursive;
            text-shadow: 2px 2px 0 #ff0000, 4px 4px 0 #00ff00, 6px 6px 0 #0000ff;
            animation: bounce 2.5s infinite; color: white;
        }
        .party-sub {
            font-family: monospace; font-size: .8rem;
            color: #4ADE80; margin-top: .6rem; letter-spacing: 1px; opacity: .8;
        }

        .party-content { padding: 2rem 2.5rem; background: #030303; color: #c8ffc8; }

        /* Easter egg */
        .easter-section { padding: 1.8rem 0 2rem; border-bottom: 1px solid #1a3a1a; }
        .easter-congrats {
            font-family: monospace; font-size: 1.1rem;
            color: #4ADE80; letter-spacing: 2px; margin-bottom: 1.2rem;
        }
        .easter-body { font-size: .95rem; line-height: 1.9; color: #a0c8a0; max-width: 560px; }
        .easter-body em { color: #c8ffc8; font-style: normal; }

        /* Poem */
        .poem-section { padding: 2.5rem 0; border-bottom: 1px solid #1a3a1a; }
        .poem-grid {
            display: grid; grid-template-columns: 1fr 1fr;
            gap: 2.5rem; align-items: start;
        }
        .poem-zh {
            font-family: 'PingFang SC', 'Hiragino Sans GB', 'Microsoft YaHei', 'STSong', serif;
            font-size: 1.05rem; line-height: 2.3; color: #4ADE80;
            letter-spacing: 2px; font-weight: 400;
        }
        .poem-en {
            font-family: Georgia, 'Times New Roman', serif;
            font-size: 1.05rem; line-height: 2.3; color: #e0ffe0;
            letter-spacing: .4px; padding-top: 0; opacity: .85;
        }

        /* Vault hint */
        .vault-hint {
            padding: 1.4rem 1.8rem; border: 1px dashed #2a2020;
            font-family: monospace; text-align: center;
            background: rgba(255,40,40,.02);
        }
        .vault-hint-title { color: #ff4444; font-size: .8rem; letter-spacing: 3px; margin-bottom: .6rem; opacity: .8; }
        .vault-hint-body  { color: #3a5a3a; font-size: .78rem; line-height: 1.9; }
        .vault-hint-lock  { font-size: .68rem; margin-top: .6rem; }
        #vault-locked-hint   { color: #2a2020; }
        #vault-unlocked-hint { color: #4ADE80; display: none; }

        /* Board of Life Directors */
        .board-section { padding: 2rem 0 1.5rem; border-top: 1px solid #1a3a1a; }
        .board-label {
            font-family: monospace; font-size: .72rem;
            letter-spacing: 4px; color: #FFD700;
            text-transform: uppercase; margin-bottom: .4rem;
        }
        .board-heading {
            font-size: 1.25rem; color: #c8ffc8;
            font-family: Georgia, serif;
            margin-bottom: .5rem; font-weight: normal;
        }
        .board-desc {
            font-size: .8rem; color: #3a5a3a;
            margin-bottom: 1.8rem; line-height: 1.7; font-family: monospace;
        }
        .board-question-card {
            background: rgba(255,215,0,.03); border: 1px solid #1e3a1a;
            border-left: 3px solid #FFD700; padding: 1.4rem 1.6rem; margin-bottom: 1.6rem;
            opacity: 0; transform: translateY(8px);
            transition: opacity .4s ease, transform .4s ease;
        }
        .board-question-card.revealed { opacity: 1; transform: translateY(0); }
        .board-q-label { font-size: .62rem; letter-spacing: 2px; color: #4a6a2a; font-family: monospace; margin-bottom: .6rem; text-transform: uppercase; }
        .board-q-text  { font-size: 1.15rem; color: #e0ffe0; line-height: 1.7; font-family: Georgia, serif; }

        /* Option cards */
        .board-options { display: flex; flex-direction: column; gap: .55rem; margin-bottom: 1.4rem; }
        .board-btn {
            width: 100%; display: flex; align-items: center; gap: 1rem;
            background: transparent; border: 1px solid #1a3a1a;
            padding: 1rem 1.2rem; cursor: pointer;
            font-family: monospace; transition: background .18s ease, border-color .18s ease;
            border-radius: 3px; text-align: left;
        }
        .board-btn:hover { background: rgba(74,222,128,.04); border-color: #2a5a2a; }
        .board-btn.selected { background: rgba(74,222,128,.07); border-color: #4ADE80; }
        .board-btn-indicator {
            width: 18px; height: 18px; border-radius: 50%; flex-shrink: 0;
            border: 2px solid #2a4a2a; position: relative;
            transition: border-color .18s ease, background .18s ease;
        }
        .board-btn.selected .board-btn-indicator { border-color: #4ADE80; background: #4ADE80; }
        .board-btn.selected .board-btn-indicator::after {
            content: ''; position: absolute; inset: 3px;
            background: #030303; border-radius: 50%;
        }
        .board-btn-content { flex: 1; }
        .board-btn-label { display: block; font-size: .6rem; color: #2a5a2a; letter-spacing: 2px; margin-bottom: .25rem; text-transform: uppercase; transition: color .18s; }
        .board-btn.selected .board-btn-label { color: #4ADE80; }
        .board-btn-text  { display: block; font-size: .9rem; color: #a0c8a0; line-height: 1.45; transition: color .18s; }
        .board-btn.selected .board-btn-text { color: #e0ffe0; }

        /* Submit */
        .board-submit-btn {
            width: 100%; background: transparent; border: 1px solid #4ADE80;
            color: #4ADE80; padding: .85rem 1.4rem;
            cursor: pointer; font-family: monospace;
            font-size: .78rem; letter-spacing: 2px; text-transform: uppercase;
            transition: all .2s; display: none; border-radius: 3px;
            animation: fadeUp .3s ease both;
        }
        .board-submit-btn:hover { background: rgba(74,222,128,.1); }
        .board-submit-btn:disabled { opacity: .5; cursor: not-allowed; }
        .board-submit-btn.visible { display: block; }

        /* Voted confirmation */
        .board-voted {
            text-align: center; padding: 2.5rem 1.5rem;
            border: 1px solid #1a3a1a; background: rgba(74,222,128,.03);
            animation: fadeUp .4s ease both;
        }
        .board-voted-check { font-size: 1.8rem; margin-bottom: .8rem; }
        .board-voted-title { font-family: monospace; font-size: .9rem; color: #4ADE80; letter-spacing: 2px; margin-bottom: .4rem; }
        .board-voted-sub   { font-family: monospace; font-size: .72rem; color: #2a5a2a; }

        /* PIN gate */
        .board-pin-gate { margin-bottom: 1.4rem; }
        .board-pin-label {
            font-family: monospace; font-size: .68rem;
            color: #3a5a3a; letter-spacing: 2px;
            text-transform: uppercase; margin-bottom: .7rem;
        }
        .board-pin-row { display: flex; gap: .6rem; align-items: center; }
        .board-pin-input {
            background: transparent; border: 1px solid #2a4a2a;
            color: #4ADE80; padding: .6rem .9rem;
            font-family: monospace; font-size: 1.1rem;
            letter-spacing: 8px; width: 140px; outline: none;
            border-radius: 3px; text-align: center;
            transition: border-color .2s, box-shadow .2s;
        }
        .board-pin-input:focus { border-color: #4ADE80; box-shadow: 0 0 0 1px rgba(74,222,128,.2); }
        .board-pin-input.shake { animation: pin-shake .35s ease; }
        @keyframes pin-shake {
            0%,100% { transform: translateX(0); }
            20%,60% { transform: translateX(-5px); }
            40%,80% { transform: translateX(5px); }
        }
        .board-pin-submit {
            background: transparent; border: 1px solid #2a4a2a;
            color: #4ADE80; padding: .6rem 1.1rem;
            cursor: pointer; font-family: monospace;
            font-size: .76rem; letter-spacing: 1px;
            transition: all .2s; border-radius: 3px;
        }
        .board-pin-submit:hover { background: rgba(74,222,128,.08); border-color: #4ADE80; }
        .board-pin-error {
            font-family: monospace; font-size: .7rem;
            color: #ff4444; margin-top: .55rem; letter-spacing: 1px;
        }

        /* Board meta / voter context */
        .board-meta {
            padding: .9rem 1.2rem 1rem; margin-bottom: 1rem;
            background: rgba(74,222,128,.02); border: 1px solid #1a3a1a;
            border-top: none; animation: fadeUp .3s ease both;
        }
        .board-meta-row { margin-bottom: .85rem; }
        .board-meta-row:last-child { margin-bottom: 0; }
        .board-meta-q {
            font-family: monospace; font-size: .65rem;
            color: #3a5a3a; letter-spacing: 1.5px;
            text-transform: uppercase; margin-bottom: .45rem;
        }
        .board-dot-row { display: flex; gap: .45rem; align-items: center; }
        .board-dot {
            width: 20px; height: 20px; border-radius: 50%;
            border: 1.5px solid #2a4a2a; cursor: pointer;
            transition: background .15s, border-color .15s, transform .12s;
            flex-shrink: 0;
        }
        .board-dot:hover { border-color: #4ADE80; transform: scale(1.12); }
        .board-dot.filled { background: rgba(74,222,128,.6); border-color: #4ADE80; }
        .board-dot-label { font-family: monospace; font-size: .62rem; color: #4ADE80; margin-left: .4rem; min-width: 80px; }
        .board-meta-textarea {
            width: 100%; background: transparent;
            border: 1px solid #1a3a1a; border-radius: 3px;
            color: #a0c8a0; padding: .55rem .8rem;
            font-family: monospace; font-size: .8rem;
            resize: none; height: 60px; outline: none;
            transition: border-color .2s; line-height: 1.5;
        }
        .board-meta-textarea:focus { border-color: #4ADE80; }
        .board-meta-textarea::placeholder { color: #2a4a2a; font-style: italic; }

        /* Admin question history */
        .admin-q-history-item {
            border: 1px solid #1a3a1a; border-radius: 2px;
            padding: .65rem .8rem; margin-bottom: .45rem; transition: background .15s;
        }
        .admin-q-history-item:hover { background: rgba(74,222,128,.02); }
        .admin-q-history-item.active-q { border-left: 3px solid #4ADE80; border-color: #4ADE80; }

        /* Party footer */
        .party-footer {
            text-align: center; padding: 1.2rem 2rem;
            background: #030303; border-top: 4px solid #4ADE80;
            color: #2a6e2a; font-family: monospace; font-size: .7rem; letter-spacing: 2px;
        }

        /* Buttons */
        .emergency-exit {
            display: none; position: fixed; top: 10px; right: 10px;
            background: rgba(0,0,0,.85); color: #ff4444; border: 1px solid #ff4444;
            padding: 7px 14px; cursor: pointer; font-family: monospace;
            z-index: 1000; border-radius: 3px; font-size: .72rem; letter-spacing: 1px;
            transition: all .2s;
        }
        .emergency-exit:hover { background: #ff4444; color: white; }
        .emergency-exit.active { display: block; }

        #vault-float-btn {
            display: none; position: fixed; bottom: 12px; left: 12px;
            background: rgba(5,0,0,.92); color: #ff4444; border: 1px solid #ff4444;
            padding: 6px 12px; cursor: pointer; font-family: monospace;
            font-size: .7rem; z-index: 999; border-radius: 3px;
            transition: all .2s; opacity: .65; letter-spacing: 1px;
        }
        #vault-float-btn:hover { opacity: 1; background: #ff4444; color: white; }

        @media (max-width: 600px) {
            .party-domain { font-size: min(11vw, 2.5rem); }
            .party-content { padding: 1.2rem; }
            .poem-grid { grid-template-columns: 1fr; gap: 1rem; }
            .poem-zh { font-size: 1.05rem; }
            .board-options { flex-direction: column; }
        }

        /* ‚îÄ‚îÄ‚îÄ ADMIN OVERLAY ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ */
        .admin-overlay { display:none; position:fixed; inset:0; background:rgba(0,4,20,.98); z-index:4000; overflow-y:auto; font-family:monospace; }
        .admin-overlay.active { display:block; }
        .admin-container { max-width:860px; margin:0 auto; padding:1.5rem; }
        .admin-header { text-align:center; border-bottom:2px solid #4ADE80; padding-bottom:1rem; margin-bottom:1.5rem; position:relative; }
        .admin-title { font-size:1.4rem; color:#4ADE80; letter-spacing:4px; text-transform:uppercase; }
        .admin-subtitle { font-size:.68rem; color:#2a4a2a; letter-spacing:3px; margin-top:.3rem; text-transform:uppercase; }
        .admin-close-btn { position:absolute; top:0; right:0; background:#4ADE80; color:#030303; border:none; padding:7px 14px; cursor:pointer; font-family:monospace; font-size:.8rem; font-weight:bold; }
        .admin-tabs { display:flex; gap:0; margin-bottom:1.5rem; border-bottom:1px solid #1a3a1a; }
        .admin-tab { background:transparent; border:none; border-bottom:2px solid transparent; color:#2a5a2a; padding:.5rem 1.1rem; cursor:pointer; font-family:monospace; font-size:.75rem; letter-spacing:1px; text-transform:uppercase; margin-bottom:-1px; transition:all .2s; }
        .admin-tab:hover { color:#4ADE80; }
        .admin-tab.active { color:#4ADE80; border-bottom-color:#4ADE80; }
        .admin-panel { display:none; }
        .admin-panel.active { display:block; }
        .admin-section { margin-bottom:1.4rem; }
        .admin-label { font-size:.65rem; letter-spacing:2px; color:#2a5a2a; text-transform:uppercase; margin-bottom:.5rem; }
        .admin-input { width:100%; background:#060606; border:1px solid #1a3a1a; color:#c8ffc8; padding:.5rem .8rem; font-family:monospace; font-size:.82rem; outline:none; box-sizing:border-box; margin-bottom:.5rem; border-radius:2px; }
        .admin-input:focus { border-color:#4ADE80; }
        .admin-btn { background:transparent; border:1px solid #4ADE80; color:#4ADE80; padding:.42rem .85rem; cursor:pointer; font-family:monospace; font-size:.72rem; letter-spacing:1px; transition:all .2s; margin-right:.4rem; margin-bottom:.4rem; border-radius:2px; }
        .admin-btn:hover { background:rgba(74,222,128,.1); }
        .admin-btn.primary { background:rgba(74,222,128,.1); }
        .admin-btn:disabled { opacity:.4; cursor:not-allowed; }
        .admin-table { width:100%; border-collapse:collapse; font-size:.75rem; }
        .admin-table th { color:#2a5a2a; text-align:left; padding:.3rem .5rem; border-bottom:1px solid #1a3a1a; letter-spacing:1px; text-transform:uppercase; font-size:.63rem; }
        .admin-table td { color:#c8ffc8; padding:.42rem .5rem; border-bottom:1px solid #0a1a0a; vertical-align:middle; }
        .admin-table tr:hover td { background:rgba(74,222,128,.025); }
        .admin-badge { display:inline-block; padding:1px 6px; font-size:.62rem; border-radius:2px; }
        .admin-badge.used   { background:rgba(255,68,68,.1); color:#ff8888; border:1px solid #3a1010; }
        .admin-badge.unused { background:rgba(74,222,128,.1); color:#4ADE80; border:1px solid #1a3a1a; }
        .admin-key-gate { text-align:center; padding:2.5rem; border:1px dashed #1a3a1a; }
        .admin-current-q { color:#4ADE80; font-size:.85rem; padding:.7rem; border:1px solid #1a3a1a; background:#060606; margin-bottom:.8rem; line-height:1.6; }
        #admin-float-btn { display:none; position:fixed; bottom:12px; left:120px; background:rgba(0,5,20,.92); color:#4ADE80; border:1px solid #4ADE80; padding:6px 12px; cursor:pointer; font-family:monospace; font-size:.7rem; z-index:999; border-radius:3px; transition:all .2s; opacity:.65; letter-spacing:1px; }
        #admin-float-btn:hover { opacity:1; background:rgba(74,222,128,.1); }

        /* ‚îÄ‚îÄ‚îÄ VAULT OVERLAY ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ */
        .vault-overlay { display:none; position:fixed; inset:0; background:rgba(2,0,0,.98); z-index:3000; overflow-y:auto; font-family:monospace; }
        .vault-overlay.active { display:block; }
        .vault-container { max-width:860px; margin:0 auto; padding:1.5rem; }
        .vault-header { text-align:center; border-bottom:2px solid #ff4444; padding-bottom:1rem; margin-bottom:1.5rem; position:relative; }
        .vault-title { font-size:1.8rem; color:#ff4444; letter-spacing:5px; text-transform:uppercase; text-shadow:0 0 20px rgba(255,68,68,.5); }
        .vault-subtitle { font-size:.68rem; color:#444; letter-spacing:3px; margin-top:.3rem; text-transform:uppercase; }
        .vault-close-btn { position:absolute; top:0; right:0; background:#ff4444; color:white; border:none; padding:7px 14px; cursor:pointer; font-family:monospace; font-size:.8rem; transition:background .2s; }
        .vault-close-btn:hover { background:#ff6666; }
        .vault-status { background:rgba(20,0,0,.9); border:1px solid #ff4444; border-left:3px solid #4ADE80; padding:.4rem 1rem; margin-bottom:1.4rem; font-size:.75rem; color:#4ADE80; display:flex; align-items:center; gap:.5rem; }
        .vault-status-dot { width:7px; height:7px; border-radius:50%; background:#4ADE80; flex-shrink:0; animation:pulse 2s infinite; }
        .vault-status-dot.error { background:#ff4444; animation:none; }
        .vault-status-dot.connecting { background:#FFD700; }
        .vault-content { margin-bottom:1.5rem; }
        .vault-section { margin-bottom:1.1rem; border:1px solid #3a1010; border-radius:3px; overflow:hidden; }
        .vault-section-header { background:rgba(20,0,0,.95); padding:.5rem 1rem; border-bottom:1px solid #3a1010; display:flex; align-items:baseline; gap:.6rem; }
        .vault-section-name { font-size:.78rem; color:#ff8888; font-weight:bold; text-transform:uppercase; letter-spacing:1px; }
        .vault-section-desc { font-size:.68rem; color:#553333; }
        .vault-section-content { padding:.65rem; background:rgba(8,0,0,.9); }
        .vault-records { display:flex; flex-direction:column; gap:.5rem; }
        .vault-entry { border:1px solid #2a1010; border-left:3px solid #ff4444; padding:.6rem; background:rgba(15,0,0,.8); word-break:break-word; }
        .vault-entry-main { font-size:.85rem; color:#ffaaaa; line-height:1.5; margin-bottom:.3rem; }
        .vault-entry-date { font-size:.62rem; color:#553333; }
        .vault-entry-tags { display:flex; gap:.3rem; flex-wrap:wrap; margin-top:.2rem; }
        .vault-tag { background:rgba(255,68,68,.07); border:1px solid #3a1010; color:#ff8888; padding:1px 5px; font-size:.6rem; border-radius:2px; }
        .vault-loading { color:#553333; font-size:.78rem; }
        .vault-empty { color:#443333; font-size:.75rem; font-style:italic; }
        .vault-error { color:#ff4444; font-size:.75rem; }
        .vault-error-state { text-align:center; padding:2rem; border:1px dashed #ff4444; color:#ffaaaa; }
        .vault-input-area { border:1px solid #3a1010; border-top:2px solid #ff4444; border-radius:3px; padding:.9rem; background:rgba(10,0,0,.95); margin-top:1.4rem; }
        .vault-input-title { font-size:.72rem; color:#ff8888; letter-spacing:2px; margin-bottom:.65rem; text-transform:uppercase; }
        .vault-textarea { width:100%; background:black; border:1px solid #3a1010; color:#ffaaaa; padding:.65rem; font-family:monospace; font-size:.82rem; resize:vertical; min-height:75px; outline:none; box-sizing:border-box; }
        .vault-textarea:focus { border-color:#ff4444; }
        .vault-textarea::placeholder { color:#332222; font-style:italic; }
        .vault-input-controls { display:flex; gap:.5rem; margin-top:.65rem; flex-wrap:wrap; align-items:center; }
        .vault-btn { background:transparent; border:1px solid #ff4444; color:#ff8888; padding:6px 12px; cursor:pointer; font-family:monospace; font-size:.74rem; transition:all .2s; }
        .vault-btn:hover { background:#ff4444; color:white; }
        .vault-btn.primary { background:#ff4444; color:white; font-weight:bold; }
        .vault-btn.primary:hover { background:#ff6666; }
        .vault-btn.recording { background:#ff4444; color:white; animation:pulse .8s infinite; }
        .vault-btn:disabled { opacity:.4; cursor:not-allowed; }
        .vault-select { flex-grow:1; background:black; border:1px solid #3a1010; color:#ff8888; padding:6px; font-family:monospace; font-size:.74rem; outline:none; }
        .vault-text-result { font-size:.82rem; color:#ffaaaa; line-height:1.55; }
    </style>
</head>
<body>

<!-- ‚îÄ‚îÄ TRANSITION OVERLAY ‚îÄ‚îÄ -->
<div class="transition-overlay" id="transition-overlay">
    <div class="boot-log" id="boot-log"></div>
    <div class="boot-bar-wrap"><div class="boot-bar" id="boot-bar"></div></div>
    <div class="boot-pct" id="boot-pct"></div>
</div>

<div class="container" id="main-container">

    <!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
         BORING MODE (parked domain)
         ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
    <div class="boring-mode" id="boring-mode">
        <div class="boring-header">
            <div class="boring-domain">machu.la</div>
            <div class="boring-tagline">This domain is parked. Bids accepted in most currencies.</div>
        </div>

        <div class="boring-shimmer" aria-hidden="true"></div>

        <div class="boring-content">

            <div class="boring-ad" data-trigger="domain">
                <div class="ad-label">Sponsored</div>
                <div class="ad-title">Premium Cognitive Real Estate ‚Äî Acquiring Now</div>
                <div class="ad-url">cortex-capital.io ‚Ä∫ acquisitions ‚Ä∫ frontal-lobe</div>
                <div class="ad-body">Prefrontal cortex leaseback options available. Amygdala overrides delivered Q4. <span style="color:#888">Hippocampus Premium tier: now enrolling.</span></div>
            </div>

            <div class="boring-ad" data-trigger="hosting">
                <div class="ad-label">Sponsored</div>
                <div class="ad-title">Full Limbic Recalibration ‚Äî Neural Enhancement Suite</div>
                <div class="ad-url">pathforwardneurotech.com ‚Ä∫ optimize ‚Ä∫ defaults</div>
                <div class="ad-body">Default mode network override. Pattern interrupt at the neurological level. <span style="color:#888">One (1) genuine epiphany included. Results may include clarity, mild vertigo, and an inexplicable urge to rethink everything.</span></div>
            </div>

            <div class="boring-ad" data-trigger="contact">
                <div class="ad-label">Sponsored</div>
                <div class="ad-title">Speaking Engagements &amp; Consulting ‚Äî $2,400/hr</div>
                <div class="ad-url">anthonymachula.ca ‚Ä∫ speaking ‚Ä∫ inquiries</div>
                <div class="ad-body">Brain optimization. Pattern interrupts. Decisions that scale. Limited availability. <span style="color:#888">Your organization's amygdala will thank you.</span></div>
            </div>

            <div id="contact-form-section" class="boring-contact-form" style="display:none;">
                <div style="text-align:right;">
                    <button class="close-form" style="border:none;background:none;color:#999;cursor:pointer;font-size:12px;">‚úï close</button>
                </div>
                <form id="boring-contact-form" method="POST" action="https://formspree.io/f/REPLACE_WITH_YOUR_FORM_ID" style="color:#333;">
                    <input type="hidden" name="_subject" value="Neural Sprint Inquiry üß†">
                    <h3 style="color:#1a0dab;margin-bottom:16px;font-size:15px;">Contact Domain Broker</h3>
                    <div class="form-group">
                        <label>Your "Real" Name:</label>
                        <input type="text" name="name" id="name-input" class="boring-input" placeholder="We both know it's not your real name...">
                    </div>
                    <div class="form-group hidden" id="email-field">
                        <label>Neural Sprint Invoice Email:</label>
                        <input type="email" name="email" class="boring-input" placeholder="For the bill. Non-negotiable.">
                    </div>
                    <div class="form-group hidden" id="reality-check">
                        <label>Existence Validation:</label>
                        <select name="existence" class="boring-input">
                            <option>*sigh* Please select...</option>
                            <option>Yes, I definitely exist (sure you do)</option>
                            <option>I think, therefore I might exist?</option>
                            <option>My LinkedIn says I'm real</option>
                            <option>Error 404: Self not found</option>
                            <option value="trigger">ALL GLORY TO THE HYPNOTOAD</option>
                        </select>
                    </div>
                    <div class="form-group hidden" id="intent-field">
                        <label>Why Are You Really Here?</label>
                        <select name="intent" class="boring-input">
                            <option>Oh, let me guess...</option>
                            <option>Procrastinating something that would genuinely change my life</option>
                            <option>My cold plunge timer ran out</option>
                            <option>Looking for meaning in parked domains (found some?)</option>
                            <option>My cat walked on the keyboard ‚Äî and honestly had a point</option>
                            <option>A Notion doc full of Naval quotes sent me here</option>
                        </select>
                    </div>
                    <div class="form-group hidden" id="budget-field">
                        <label>Your "Budget":</label>
                        <select name="budget" class="boring-input">
                            <option>Pick your imaginary budget...</option>
                            <option>The lint in my Lululemon pocket</option>
                            <option>Three fiddy and a microdose</option>
                            <option>One slightly pre-optimized soul</option>
                            <option>‚àû exposure, LinkedIn reach, and vibes</option>
                        </select>
                    </div>
                    <div class="form-group hidden" id="captcha-field">
                        <label>Human Verification:</label>
                        <div class="boring-input" style="text-align:center;cursor:pointer;color:#666;">
                            Please click all squares containing existential dread
                            <div style="margin-top:8px;font-style:italic;font-size:11px;">[ Error: All squares contain existential dread ]</div>
                        </div>
                    </div>
                    <button type="submit" class="boring-submit">Submit (if you must)</button>
                    <div style="text-align:center;margin-top:8px;font-size:10px;color:#aaa;">
                        * All responses will be carefully read and then manifested
                    </div>
                </form>
            </div>
        </div>

        <div class="boring-footer">
            <div>¬© 2025 Domain Parking Service &nbsp;¬∑&nbsp; All Dimensions Reserved</div>
            <div style="margin-top:6px;">
                Visitors today: 1,337 &nbsp;¬∑&nbsp;
                Neurons fired: <span id="sneak-attack" style="cursor:pointer;text-decoration:underline dotted;">‚àû</span>
            </div>
        </div>
    </div>


    <!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
         PARTY MODE
         ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
    <div class="party-mode" id="party-mode">

        <div class="party-header">
            <div class="party-domain">machu.la</div>
            <div class="party-sub">
                Enlightenment Level: <span id="stardate"></span>
            </div>
        </div>

        <div class="party-content">

            <!-- Board of Life Directors -->
            <div class="board-section">
                <div class="board-label">ü™ë The Board of Life Directors</div>
                <div class="board-heading">Major decisions deserve more than one operating system.</div>
                <div class="board-desc">
                    If you're here, I probably sent you this link.
                    There's a real question below. Your vote matters and goes directly to my consciousness cloud‚Ñ¢.
                </div>

                <!-- PIN gate -->
                <div class="board-pin-gate" id="board-pin-gate">
                    <div class="board-pin-label">Board access PIN required</div>
                    <div class="board-pin-row">
                        <input type="password" class="board-pin-input" id="board-pin-input" maxlength="8" placeholder="¬∑ ¬∑ ¬∑ ¬∑" autocomplete="off">
                        <button class="board-pin-submit" id="board-pin-submit">Unlock ‚Üó</button>
                    </div>
                    <div class="board-pin-error hidden" id="board-pin-error">‚ö† Incorrect PIN</div>
                </div>

                <div id="board-question-card" class="board-question-card" style="display:none;">
                    <div class="board-q-label">Current question before the board:</div>
                    <div class="board-q-text" id="board-q-text"></div>
                </div>

                <div id="board-vote-area" style="display:none;">
                    <div class="board-options" id="board-options"></div>
                    <!-- Voter context ‚Äî revealed after selecting an option -->
                    <div class="board-meta hidden" id="board-meta">
                        <div class="board-meta-row">
                            <div class="board-meta-q">How close are you to this issue?</div>
                            <div id="board-dots-closeness"></div>
                        </div>
                        <div class="board-meta-row">
                            <div class="board-meta-q">How well can you speak to your answer?</div>
                            <div id="board-dots-expertise"></div>
                        </div>
                        <div class="board-meta-row">
                            <textarea class="board-meta-textarea" id="board-justification" placeholder="Optional: a sentence or two on your reasoning..."></textarea>
                        </div>
                    </div>
                    <button class="board-submit-btn" id="board-submit">Cast vote ‚Üó</button>
                </div>

                <div class="board-voted hidden" id="board-voted">
                    <div class="board-voted-check">‚ú¶</div>
                    <div class="board-voted-title">Vote received.</div>
                    <div class="board-voted-sub">This genuinely helps ‚Äî thank you.</div>
                </div>
            </div>

            <!-- Easter egg welcome -->
            <div class="easter-section">
                <div class="easter-congrats">‚ú¶ &nbsp; You made it. &nbsp; ‚ú¶</div>
                <div class="easter-body">
                    Most people see a parked domain and move on.
                    You kept going ‚Äî which probably says something about you.<br><br>
                    This is <em>my corner of the internet</em>. No product. No funnel.
                    Just a poem, and maybe if you have the right PIN, a few buttons to click
                    to help me make decisions.
                </div>
            </div>

            <!-- Poem: Chinese left, English right -->
            <div class="poem-section">
                <div class="poem-grid">
                    <div class="poem-zh" lang="zh">
                        ÊûóÂéªÊ†ëÁïô„ÄÇ<br>
                        ÈÅìÂ§±Ë∂≥ËØÜ„ÄÇ<br>
                        Ëµ∑ËêΩ‰πãÈó¥Ôºå<br>
                        ÁîüÂëΩÂ¶ÇÊòØ„ÄÇ
                    </div>
                    <div class="poem-en">
                        The forest disappears.<br>
                        The trees remain.<br>
                        We forget the way.<br>
                        Our feet remember.<br>
                        Life, in its falling and rising.
                    </div>
                </div>
            </div>

            <!-- Classified vault -->
            <div class="vault-hint">
                <div class="vault-hint-title">‚ö† &nbsp; C L A S S I F I E D &nbsp; ‚ö†</div>
                <div class="vault-hint-body">
                    [ MANIFESTATION DATA ‚Äî REDACTED ]<br>
                    [ EVIDENCE VAULT CONTENTS ENCRYPTED ]
                </div>
                <div class="vault-hint-lock">
                    <span id="vault-locked-hint">üîê Vault: locked on this device</span>
                    <span id="vault-unlocked-hint">‚úÖ Vault: unlocked ‚Äî tap üîê VAULT ‚Üô</span>
                </div>
            </div>

        </div>

        <div class="party-footer">
            ‚ö° &nbsp; POWERED BY NEUROPLASTICITY &amp; PURE HUBRIS &nbsp; ‚ö°
        </div>
    </div>
</div>

<button class="emergency-exit" title="Boss Key">‚Ü© EXIT</button>
<button id="vault-float-btn">üîê VAULT</button>
<button id="admin-float-btn">‚öô BOARD ADMIN</button>

<!-- ‚îÄ‚îÄ BOARD ADMIN OVERLAY ‚îÄ‚îÄ -->
<div id="admin-overlay" class="admin-overlay">
    <div class="admin-container">
        <div class="admin-header">
            <div class="admin-title">‚öô Board Admin</div>
            <div class="admin-subtitle">pins ¬∑ questions ¬∑ results</div>
            <button id="admin-close" class="admin-close-btn">‚úï CLOSE</button>
        </div>
        <div id="admin-key-gate" class="admin-key-gate">
            <div style="color:#2a5a2a;font-size:.75rem;letter-spacing:1px;margin-bottom:.8rem;">SERVICE KEY REQUIRED</div>
            <div style="color:#3a5a3a;font-size:.72rem;line-height:1.8;">Visit <code style="color:#4ADE80;">machu.la/#sb-admin-YOUR_SERVICE_ROLE_KEY</code><br>to unlock admin on this device</div>
        </div>
        <div id="admin-main" style="display:none;">
            <div class="admin-tabs">
                <button class="admin-tab active" data-tab="question">Question</button>
                <button class="admin-tab" data-tab="pins">PINs</button>
                <button class="admin-tab" data-tab="results">Results</button>
            </div>

            <!-- Question tab -->
            <div class="admin-panel active" id="admin-tab-question">
                <div class="admin-section">
                    <div class="admin-label">Active Question</div>
                    <div class="admin-current-q" id="admin-current-q">Loading...</div>
                </div>
                <div class="admin-section">
                    <div class="admin-label">Set New Question</div>
                    <input type="text" class="admin-input" id="admin-new-q" placeholder="What's the decision?">
                    <div id="admin-options-list" style="margin-bottom:.5rem;"></div>
                    <button class="admin-btn" id="admin-add-option">+ Option</button>
                    <button class="admin-btn primary" id="admin-set-question" style="float:right;">Make Active ‚Üó</button>
                    <div style="clear:both;"></div>
                </div>
                <div class="admin-section">
                    <div class="admin-label">Question History</div>
                    <div id="admin-q-history"><div style="color:#2a5a2a;font-size:.72rem;font-style:italic;">Loading...</div></div>
                </div>
            </div>

            <!-- Pins tab -->
            <div class="admin-panel" id="admin-tab-pins">
                <div class="admin-section">
                    <div class="admin-label">Create PIN</div>
                    <div style="display:flex;gap:.5rem;flex-wrap:wrap;align-items:flex-end;">
                        <div style="flex:1;min-width:120px;">
                            <div style="font-size:.62rem;color:#2a5a2a;margin-bottom:.3rem;letter-spacing:1px;">LABEL (who is this for?)</div>
                            <input type="text" class="admin-input" id="admin-pin-label" placeholder="e.g. Sarah" style="margin:0;">
                        </div>
                        <div style="width:120px;">
                            <div style="font-size:.62rem;color:#2a5a2a;margin-bottom:.3rem;letter-spacing:1px;">PIN CODE (blank = auto)</div>
                            <input type="text" class="admin-input" id="admin-pin-code" placeholder="auto" maxlength="8" style="margin:0;">
                        </div>
                        <button class="admin-btn primary" id="admin-create-pin">Create ‚Üó</button>
                    </div>
                </div>
                <div class="admin-section">
                    <div class="admin-label">All PINs</div>
                    <table class="admin-table">
                        <thead><tr><th>Code</th><th>Label</th><th>Votes Cast</th><th>Created</th><th></th></tr></thead>
                        <tbody id="admin-pins-tbody"><tr><td colspan="5" style="color:#2a5a2a;font-style:italic;">Loading...</td></tr></tbody>
                    </table>
                </div>
            </div>

            <!-- Results tab -->
            <div class="admin-panel" id="admin-tab-results">
                <div class="admin-section" style="margin-bottom:.8rem;">
                    <select id="admin-results-filter" class="admin-input" style="margin-bottom:0;">
                        <option value="">All questions</option>
                    </select>
                </div>
                <div id="admin-pie-section" class="admin-section"></div>
                <div class="admin-section">
                    <div class="admin-label">Votes Cast</div>
                    <div style="overflow-x:auto;">
                        <table class="admin-table">
                            <thead><tr><th>Voter</th><th>Question</th><th>Choice</th><th>Close</th><th>Expert</th><th>Reasoning</th><th>When</th><th></th></tr></thead>
                            <tbody id="admin-results-tbody"><tr><td colspan="8" style="color:#2a5a2a;font-style:italic;">Loading...</td></tr></tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- ‚îÄ‚îÄ PROOF VAULT OVERLAY ‚îÄ‚îÄ -->
<div id="vault-overlay" class="vault-overlay">
    <div class="vault-container">
        <div class="vault-header">
            <div class="vault-title">üîê Proof Vault</div>
            <div class="vault-subtitle">evidence-based reality anchor</div>
            <button id="vault-close" class="vault-close-btn">‚úï SEAL</button>
        </div>
        <div class="vault-status">
            <span class="vault-status-dot connecting" id="vault-dot"></span>
            <span id="vault-status-text">Awaiting connection...</span>
        </div>
        <div id="vault-content" class="vault-content">
            <div class="vault-empty" style="padding:1rem;">Open the vault to load evidence.</div>
        </div>
        <div class="vault-input-area">
            <div class="vault-input-title">üì° New Transmission</div>
            <textarea id="vault-new-entry" class="vault-textarea" placeholder="Speak your truth (or dictate it)..."></textarea>
            <div class="vault-input-controls">
                <button id="vault-mic-btn" class="vault-btn">üé§ DICTATE</button>
                <select id="vault-tool-select" class="vault-select">
                    <option value="">‚Äî select tool ‚Äî</option>
                </select>
                <button id="vault-submit-btn" class="vault-btn primary">TRANSMIT</button>
            </div>
            <div style="margin-top:.6rem;text-align:right;">
                <button id="vault-relock-btn" class="vault-btn" style="font-size:.65rem;opacity:.45;">clear token &amp; re-lock</button>
            </div>
        </div>
    </div>
</div>

<script>
// ================================================================
// SUPABASE CONFIG ‚Äî replace these two values after creating your project
// Project URL + anon key: Supabase dashboard ‚Üí Settings ‚Üí API
// ================================================================
const SUPABASE_URL  = 'https://cnzsytyjsenvyemmvwzv.supabase.co';
const SUPABASE_ANON = 'sb_publishable__-nh8fWDdRRAGlDqRbaRiQ_uOKlmpnJ';
const SB_ADMIN_LSKEY = 'sb-admin-key';

let _sb = null, _sbAdmin = null;
function getSb() {
    if (!_sb && !SUPABASE_URL.includes('REPLACE'))
        _sb = supabase.createClient(SUPABASE_URL, SUPABASE_ANON);
    return _sb;
}
function getSbAdmin() {
    if (_sbAdmin) return _sbAdmin;
    const k = localStorage.getItem(SB_ADMIN_LSKEY);
    if (!k || SUPABASE_URL.includes('REPLACE')) return null;
    _sbAdmin = supabase.createClient(SUPABASE_URL, k);
    return _sbAdmin;
}

// ================================================================
// BOARD FALLBACK ‚Äî used until Supabase is configured
// ================================================================
const BOARD = {
    pin: '1234',   // ‚Üê fallback PIN (only used if Supabase not yet configured)
    question: "Should I double down on the Toronto market or expand PFN internationally first?",
    options: [
        { id: 'a', label: 'Option A', text: 'Double down on Toronto ‚Äî own the market first'       },
        { id: 'b', label: 'Option B', text: 'Go international ‚Äî the window is open now'            },
        { id: 'c', label: 'Option C', text: "Both, in parallel ‚Äî the constraint is a story I'm telling myself" },
    ]
};

// ================================================================
// BOOT SEQUENCE
// ================================================================
const BOOT_SEQUENCE = [
    { text: '> initializing neural_sprint_v3.4...',               cls: 'dim',  ms: 180 },
    { text: '> scanning for unoptimized beliefs...  [3 FOUND]',   cls: 'warn', ms: 240 },
    { text: '> migrating ego to cloud (free tier)...              [DEPRECATED]', cls: 'dim', ms: 180 },
    { text: '> consulting Tibetan monks of Silicon Valley...  [QUEUE: 847]', cls: '', ms: 300 },
    { text: '> TRUTH FOUND IN UNDER 60 SESSIONS',                 cls: '',     ms: 480 },
    { text: '> vibes: CALIBRATED  ‚úì',                             cls: 'done', ms: 280 },
];

const sleep = ms => new Promise(r => setTimeout(r, ms));

// ================================================================
// DOM REFS
// ================================================================
const transOverlay = document.getElementById('transition-overlay');
const bootLog      = document.getElementById('boot-log');
const bootBar      = document.getElementById('boot-bar');
const bootPct      = document.getElementById('boot-pct');
const container    = document.getElementById('main-container');
const body         = document.body;
const boringMode   = document.getElementById('boring-mode');
const partyMode    = document.getElementById('party-mode');
const exitButton   = document.querySelector('.emergency-exit');

async function runBootSequence() {
    bootLog.innerHTML = ''; bootBar.style.width = '0%'; bootPct.textContent = '';

    const linePromise = (async () => {
        for (const step of BOOT_SEQUENCE) {
            const el = document.createElement('div');
            el.className = 'boot-line' + (step.cls ? ' ' + step.cls : '');
            el.textContent = step.text;
            bootLog.appendChild(el);
            await sleep(20); el.classList.add('show'); await sleep(step.ms);
        }
    })();

    const barPromise = (async () => {
        for (let p = 0; p <= 33; p++) { bootBar.style.width = p + '%'; await sleep(20); }
        await sleep(100); bootBar.style.width = '29%'; await sleep(80);
        for (let p = 29; p <= 69; p++) { bootBar.style.width = p + '%'; await sleep(14); }
        bootPct.textContent = '69% ‚Äî recalibrating vibes...';
        await sleep(820); bootPct.textContent = '';
        for (let p = 69; p <= 100; p++) { bootBar.style.width = p + '%'; await sleep(9); }
    })();

    await Promise.all([linePromise, barPromise]);
    await sleep(300);
}

async function initiatePartyMode() {
    boringMode.style.transition = 'opacity .4s ease';
    boringMode.style.opacity = '0';
    await sleep(350);

    transOverlay.classList.add('active');
    await sleep(16);
    transOverlay.classList.add('visible');
    await runBootSequence();
    transOverlay.classList.remove('visible');
    await sleep(500);
    transOverlay.classList.remove('active');

    activatePartyMode();
}

function activatePartyMode() {
    body.classList.add('party-active');
    container.classList.add('party-active');
    boringMode.style.display = 'none';
    partyMode.classList.add('active');
    exitButton.classList.add('active');
    updateStardate();
    updateVaultUI();
    buildBoard();
}

// ================================================================
// EXIT
// ================================================================
exitButton.addEventListener('click', () => {
    partyMode.style.transition = 'opacity .4s ease';
    partyMode.style.opacity = '0';
    setTimeout(() => {
        body.classList.remove('party-active');
        container.classList.remove('party-active');
        partyMode.classList.remove('active');
        partyMode.style.opacity = '';
        boringMode.style.display = 'block';
        boringMode.style.opacity = '0';
        boringMode.style.transition = 'opacity .5s ease';
        requestAnimationFrame(() => requestAnimationFrame(() => { boringMode.style.opacity = '1'; }));
        exitButton.classList.remove('active');
    }, 400);
});

// ================================================================
// BOARD OF LIFE DIRECTORS
// ================================================================
async function buildBoard() {
    const useSupa = !!getSb();

    // Load active question from Supabase, fall back to BOARD constant
    let qText = BOARD.question, qOpts = BOARD.options, qId = null;
    if (useSupa) {
        try {
            const { data } = await getSb()
                .from('board_questions').select('*').eq('active', true).single();
            if (data) { qText = data.question; qOpts = data.options; qId = data.id; }
        } catch (_) {}
    }
    document.getElementById('board-q-text').textContent = qText;

    // ‚îÄ‚îÄ PIN gate ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    const pinInput     = document.getElementById('board-pin-input');
    const pinSubmit    = document.getElementById('board-pin-submit');
    const pinError     = document.getElementById('board-pin-error');
    const pinGate      = document.getElementById('board-pin-gate');
    const questionCard = document.getElementById('board-question-card');
    const voteArea     = document.getElementById('board-vote-area');

    function revealVoteUI() {
        pinGate.classList.add('hidden');
        questionCard.style.display = '';
        voteArea.style.display = '';
        pinError.classList.add('hidden');
        // Trigger fade-in on question card
        requestAnimationFrame(() => requestAnimationFrame(() => questionCard.classList.add('revealed')));
        buildVoteButtons();
    }

    async function unlockBoard() {
        const pin = pinInput.value.trim();
        if (!pin) return;
        if (!useSupa) {
            if (pin === BOARD.pin) { revealVoteUI(); }
            else {
                pinError.textContent = '‚ö† Incorrect PIN';
                pinError.classList.remove('hidden');
                pinInput.value = '';
                pinInput.classList.add('shake');
                setTimeout(() => pinInput.classList.remove('shake'), 400);
                pinInput.focus();
            }
            return;
        }
        // Validate PIN against Supabase before revealing anything
        pinSubmit.textContent = '...'; pinSubmit.disabled = true;
        const { data: valid } = await getSb().rpc('check_pin', { p_pin_code: pin });
        pinSubmit.textContent = 'Unlock ‚Üó'; pinSubmit.disabled = false;
        if (valid) {
            revealVoteUI();
        } else {
            pinError.textContent = '‚ö† Invalid PIN';
            pinError.classList.remove('hidden');
            pinInput.value = '';
            pinInput.classList.add('shake');
            setTimeout(() => pinInput.classList.remove('shake'), 400);
            pinInput.focus();
        }
    }

    pinSubmit.addEventListener('click', unlockBoard);
    pinInput.addEventListener('keydown', e => { if (e.key === 'Enter') unlockBoard(); });

    // ‚îÄ‚îÄ Vote buttons ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    function buildVoteButtons() {
        const optsEl   = document.getElementById('board-options');
        const metaEl   = document.getElementById('board-meta');
        const submitEl = document.getElementById('board-submit');
        optsEl.innerHTML = '';
        if (metaEl) metaEl.classList.add('hidden');
        submitEl.classList.remove('visible');

        let selected = null, closenessVal = null, expertiseVal = null;

        function buildDotRating(containerId, labels, onSelect) {
            const container = document.getElementById(containerId);
            if (!container) return;
            container.innerHTML = '';
            const row = document.createElement('div');
            row.className = 'board-dot-row';
            const labelEl = document.createElement('span');
            labelEl.className = 'board-dot-label';
            for (let i = 1; i <= labels.length; i++) {
                const dot = document.createElement('span');
                dot.className = 'board-dot';
                dot.addEventListener('click', () => {
                    row.querySelectorAll('.board-dot').forEach((d, idx) => d.classList.toggle('filled', idx < i));
                    labelEl.textContent = labels[i - 1] || '';
                    onSelect(i);
                });
                row.appendChild(dot);
            }
            row.appendChild(labelEl);
            container.appendChild(row);
        }

        qOpts.forEach(opt => {
            const btn = document.createElement('button');
            btn.className = 'board-btn';
            btn.innerHTML = `
                <span class="board-btn-indicator"></span>
                <span class="board-btn-content">
                    <span class="board-btn-label">${opt.label || 'Option ' + opt.id.toUpperCase()}</span>
                    <span class="board-btn-text">${opt.text}</span>
                </span>`;
            btn.addEventListener('click', () => {
                selected = opt.id;
                optsEl.querySelectorAll('.board-btn').forEach(b => b.classList.remove('selected'));
                btn.classList.add('selected');
                if (metaEl) metaEl.classList.remove('hidden');
                submitEl.classList.add('visible');
            });
            optsEl.appendChild(btn);
        });

        buildDotRating('board-dots-closeness',
            ['Observer', 'Aware', 'Involved', 'Close', 'Deeply affected'],
            v => { closenessVal = v; });
        buildDotRating('board-dots-expertise',
            ['Gut feeling', 'Some context', 'Informed', 'Knowledgeable', 'Expert'],
            v => { expertiseVal = v; });

        submitEl.addEventListener('click', async function() {
            if (!selected) return;
            const choice = qOpts.find(o => o.id === selected);
            const pin    = pinInput.value.trim();
            const justification = (document.getElementById('board-justification')?.value || '').trim() || null;
            this.textContent = 'Submitting...'; this.disabled = true;

            if (useSupa && qId) {
                const { data, error } = await getSb().rpc('cast_vote', {
                    p_pin_code:      pin,
                    p_question_id:   qId,
                    p_choice_id:     selected,
                    p_choice_text:   choice?.text || selected,
                    p_closeness:     closenessVal,
                    p_expertise:     expertiseVal,
                    p_justification: justification
                });
                if (error || !data?.success) {
                    const msg = data?.error === 'already_voted'
                        ? '‚ö† You already voted on this question'
                        : data?.error === 'invalid_pin'
                        ? '‚ö† Invalid PIN'
                        : '‚ö† Something went wrong ‚Äî try again';
                    questionCard.classList.remove('revealed');
                    questionCard.style.display = 'none';
                    voteArea.style.display = 'none';
                    pinGate.classList.remove('hidden');
                    pinError.textContent = msg;
                    pinError.classList.remove('hidden');
                    pinInput.value = '';
                    pinInput.classList.add('shake');
                    setTimeout(() => pinInput.classList.remove('shake'), 400);
                    pinInput.focus();
                    this.textContent = 'Cast vote ‚Üó'; this.disabled = false;
                    return;
                }
            }

            document.getElementById('board-vote-area').classList.add('hidden');
            document.getElementById('board-voted').classList.remove('hidden');
        });
    }
}

// ================================================================
// BORING MODE ADS
// ================================================================

// Contact
document.querySelector('[data-trigger="contact"]').addEventListener('click', function() {
    document.getElementById('contact-form-section').style.display = 'block';
    this.style.display = 'none';
});
document.querySelector('.close-form').addEventListener('click', function() {
    document.getElementById('contact-form-section').style.display = 'none';
    document.querySelector('[data-trigger="contact"]').style.display = 'block';
});
document.getElementById('name-input').addEventListener('input', function() {
    if (this.value.length > 0) document.getElementById('email-field').classList.add('reveal');
});
document.querySelector('#email-field input').addEventListener('input', function() {
    if (this.value.length > 2) document.getElementById('reality-check').classList.add('reveal');
});
document.querySelector('#reality-check select').addEventListener('change', function() {
    document.getElementById('intent-field').classList.add('reveal');
    if (this.value === 'trigger') initiatePartyMode();
});
document.querySelector('#intent-field select').addEventListener('change', function() {
    document.getElementById('budget-field').classList.add('reveal');
});
document.querySelector('#budget-field select').addEventListener('change', function() {
    document.getElementById('captcha-field').classList.add('reveal');
});
document.getElementById('boring-contact-form').addEventListener('submit', function(e) {
    e.preventDefault(); initiatePartyMode();
});

// Domain ad
function gDomain() {
    const pre=['quantum','cyber','meta','neural','crypto','synth','omega','ultra','nano','hyper'];
    const suf=['verse','mind','flux','sync','node','core','matrix','sphere','nexus','cortex'];
    const tld=['.io','.ai','.eth','.meta','.void','.‚àû','.error','.reality'];
    return pre[Math.random()*pre.length|0]+suf[Math.random()*suf.length|0]+tld[Math.random()*tld.length|0];
}
function gPrice() {
    const c=['Souls','BTC','Human Years','Brain Cells','Dreams','Reality Shards','Time Crystals'];
    return `${(Math.random()*9999+1000|0).toLocaleString()} ${c[Math.random()*c.length|0]}`;
}
function gStatus() {
    const s=["Possibly available","Schr√∂dinger's domain","Loading...","Ask again later","Reality check pending","DNS machine broke","404 in time-space"];
    return s[Math.random()*s.length|0];
}
function gErr(n) {
    const m=["ERROR: NOT WORTHY","INSUFFICIENT CHAOS","REALITY.EXE FAILED","TRY AGAIN NEVER","*disappointed sigh*","TASK FAILED SUCCESSFULLY"];
    return m[Math.min(n,m.length-1)];
}

document.querySelector('[data-trigger="domain"]').addEventListener('click', function(e) {
    e.preventDefault();
    const ac = this.querySelector('div:last-child');
    let html = `<div style="text-align:left;padding:10px;margin-top:10px;font-size:12px;">
        <div style="font-weight:bold;margin-bottom:8px;letter-spacing:1px;font-family:monospace;">SCANNING QUANTUM REALM FOR D0M41NS...</div>`;
    for (let i = 0; i < 5; i++) {
        html += `<div class="domain-entry" style="display:flex;justify-content:space-between;margin:4px 0;padding:5px;background:#f8f9fa;font-family:monospace;font-size:11px;">
            <span class="domain-name" style="flex-grow:1;">${gDomain()}</span>
            <span class="domain-price" style="color:#666;min-width:110px;text-align:right;">${gPrice()}</span>
            <span class="domain-status" style="font-size:.8em;color:#aaa;margin-left:8px;">${gStatus()}</span>
        </div>`;
    }
    html += `<button class="soul-button" style="width:100%;margin-top:10px;padding:9px;background:#1a0dab;color:white;border:none;cursor:pointer;font-size:12px;font-family:monospace;">EXCHANGE SOUL FOR DOMAIN (NO REFUNDS)</button>
    <div style="font-size:8px;text-align:center;margin-top:4px;font-family:monospace;color:#aaa;">* Soul value may vary. Not valid in this dimension. Previous incarnations affect trade-in value.</div>`;
    ac.innerHTML = html;

    const sb = ac.querySelector('.soul-button');
    let bState = 0, dodgeCount = 0;
    sb.addEventListener('click', function(ev) {
        ev.preventDefault(); ev.stopPropagation();
        if (bState === 0)      { this.style.width='90%'; this.innerHTML='N1C3 TRY H4X0R... Ôºà‚ïØ¬∞‚ñ°¬∞Ôºâ‚ïØÔ∏µ ‚îª‚îÅ‚îª'; this.style.background='#ff4444'; bState++; }
        else if (bState === 1) { this.style.width='80%'; this.innerHTML='PERSISTENCE DETECTED... ‡≤†_‡≤†'; this.style.background='#ff6666'; this.style.transform='rotate(2deg)'; bState++; }
        else                   { this.innerHTML='FINE... ‡ºº „Å§ ‚óï_‚óï ‡ºΩ„Å§'; setTimeout(initiatePartyMode, 500); }
    });
    sb.addEventListener('mouseover', function() {
        dodgeCount++;
        if (dodgeCount > 2 && bState < 2) {
            const pr = ac.getBoundingClientRect(), sr = this.getBoundingClientRect();
            this.style.position = 'absolute';
            this.style.left = Math.max(0, Math.min(Math.random() * (pr.width - sr.width), pr.width - sr.width)) + 'px';
            this.style.top  = Math.max(0, Math.min(Math.random() * (pr.height - sr.height), pr.height - sr.height)) + 'px';
            this.style.transform = `rotate(${Math.sin(dodgeCount) * 8}deg)`;
        }
    });
    setInterval(() => {
        document.querySelectorAll('.domain-entry').forEach(entry => {
            if (Math.random() > .85) { const p = entry.querySelector('.domain-price'); p.textContent = gPrice(); p.style.transform = 'scale(1.08)'; setTimeout(() => p.style.transform = 'scale(1)', 180); }
            if (Math.random() > .92) entry.querySelector('.domain-status').textContent = gStatus();
        });
    }, 2200);
});

// Hosting ad
document.querySelector('[data-trigger="hosting"]').addEventListener('click', function(e) {
    e.preventDefault();
    const ac = this.querySelector('div:last-child');
    ac.innerHTML = `<div style="padding:14px 0;font-size:13px;">
        <div style="font-weight:bold;margin-bottom:10px;color:#1a0dab;">Reality Hosting Assessment Protocol</div>
        <div style="color:#888;font-size:11px;margin-bottom:10px;">* Your choices will determine your fate</div>
        <label style="font-size:12px;">Technical Expertise Level:</label>
        <select class="boring-input" data-type="expertise" style="margin-top:5px;">
            <option value="">Select your level of delusion...</option>
            <option value="noob">I once pressed F12 and felt like a hacker</option>
            <option value="css">I can center a div (sometimes)</option>
            <option value="stackoverflow">Stack Overflow is my homepage</option>
            <option value="trigger">ALL GLORY TO THE HYPNOTOAD</option>
        </select>
        <div class="hosting-plans" style="margin-top:12px;"></div>
    </div>`;

    const planData = {
        noob: [
            { title:"TRAINING WHEELS REALITY", price:"$4.99/confusion", features:["Stack Overflow Premium","Panic Button Support","Auto-save (60% of the time)","Undo Life Choices"] },
            { title:"FAKE IT TILL YOU MAKE IT", price:"$‚àû/imposter", features:["Corporate Buzzword Generator","Meeting Simulator","LinkedIn Auto-Bragger","Confidence Synthesizer"], hi:true },
        ],
        css: [
            { title:"FLEXBOX NIGHTMARE", price:"margin: auto;", features:["!important Priority Support","Z-index: 999999","Emergency CSS Reset"] },
            { title:"ENTERPRISE CSS SOLUTION", price:"float: none;", features:["Legacy IE Support","Table-based Layouts","Bootstrap 2.0"], hi:true },
        ],
        stackoverflow: [
            { title:"COPY-PASTE STARTER PACK", price:"15 rep/month", features:["Auto-Copy Best Answer","Duplicate Question Finder","Actually Marked as Answer"] },
            { title:"ENTERPRISE OVERFLOW", price:"Closed as Duplicate", features:["Legacy Code Generator","Technical Debt Maximizer","Agile Waterfall Hybrid"], hi:true },
        ]
    };

    ac.querySelector('[data-type="expertise"]').addEventListener('change', function() {
        if (this.value === 'trigger') { initiatePartyMode(); return; }
        const plans = planData[this.value]; if (!plans) return;
        const pc = ac.querySelector('.hosting-plans');
        pc.innerHTML = `<div style="display:grid;grid-template-columns:repeat(${plans.length},1fr);gap:8px;">` +
            plans.map(p => `<div style="border:1px solid ${p.hi?'#1a0dab':'#ddd'};padding:10px;text-align:center;font-size:11px;">
                <div style="font-weight:bold;font-size:10px;margin-bottom:6px;">${p.title}</div>
                <div style="font-size:20px;margin:8px 0;font-family:monospace;">${p.price}</div>
                <ul style="text-align:left;margin:8px 0;">${p.features.map(f=>`<li>${f}</li>`).join('')}</ul>
                <button class="plan-btn boring-submit" style="width:100%;font-size:10px;padding:6px;">${p.hi?'MORTGAGE YOUR SOUL':'EMBRACE MEDIOCRITY'}</button>
            </div>`).join('') + '</div>';
        let cc = 0;
        pc.querySelectorAll('.plan-btn').forEach(btn => {
            btn.addEventListener('click', function(ev) {
                ev.preventDefault(); cc++;
                if (cc > 3) { initiatePartyMode(); return; }
                this.textContent = gErr(cc); this.style.background = '#ff4444';
            });
        });
    });
});

// ================================================================
// MISC
// ================================================================
document.getElementById('sneak-attack').addEventListener('click', initiatePartyMode);

document.addEventListener('keydown', e => {
    if (e.key === 'Escape') {
        const ao = document.getElementById('admin-overlay');
        const vo = document.getElementById('vault-overlay');
        if (ao.classList.contains('active')) ao.classList.remove('active');
        else if (vo.classList.contains('active')) vo.classList.remove('active');
        else if (exitButton.classList.contains('active')) exitButton.click();
    }
});

// #board shortcut ‚Äî skip straight to party mode, scroll to board
if (window.location.hash === '#board') {
    document.addEventListener('DOMContentLoaded', () => {
        setTimeout(() => {
            activatePartyMode();
            setTimeout(() => document.querySelector('.board-section')?.scrollIntoView({ behavior:'smooth' }), 500);
        }, 200);
    });
}

function updateStardate() {
    const el = document.getElementById('stardate');
    if (el) el.textContent = `${new Date().getFullYear()+376}.${Math.random()*9|0}`;
}
updateStardate();
setInterval(updateStardate, 5000);

// ================================================================
// PROOF VAULT
// ================================================================
const VAULT_SSE_URL   = 'https://proof-vault-mcp.x-25e.workers.dev/sse';
const VAULT_TOKEN_KEY = 'proof-vault-gh-token';

(function checkVaultUnlock() {
    const hash = window.location.hash;
    if (hash.startsWith('#vault-')) {
        const token = decodeURIComponent(hash.slice(7));
        if (token) { localStorage.setItem(VAULT_TOKEN_KEY, token); history.replaceState(null, '', window.location.pathname + window.location.search); }
    }
    if (hash.startsWith('#sb-admin-')) {
        const key = decodeURIComponent(hash.slice(10));
        if (key) { localStorage.setItem(SB_ADMIN_LSKEY, key); history.replaceState(null, '', window.location.pathname + window.location.search); }
    }
    updateVaultUI();
})();

function getVaultToken() { return localStorage.getItem(VAULT_TOKEN_KEY); }
function updateVaultUI() {
    const token=getVaultToken(), fb=document.getElementById('vault-float-btn'), lh=document.getElementById('vault-locked-hint'), uh=document.getElementById('vault-unlocked-hint');
    if(fb) fb.style.display=token?'block':'none';
    if(lh) lh.style.display=token?'none':'inline';
    if(uh) uh.style.display=token?'inline':'none';
    // Show admin button whenever service key is stored
    const ab=document.getElementById('admin-float-btn');
    if(ab) ab.style.display=localStorage.getItem(SB_ADMIN_LSKEY)?'block':'none';
}

class VaultMCPClient {
    constructor(u,t){this.sseUrl=u;this.token=t;this.messageEndpoint=null;this.pending={};this.nextId=1;this._onReady=null;}
    connect(){return new Promise((r,j)=>{this._onReady=r;this._startSSE(j);});}
    async _startSSE(onError){
        try{
            const resp=await fetch(this.sseUrl,{headers:{'Authorization':`Bearer ${this.token}`,'Accept':'text/event-stream','Cache-Control':'no-cache'}});
            if(!resp.ok){onError(new Error(`Auth failed (${resp.status})`));return;}
            const reader=resp.body.getReader(),decoder=new TextDecoder();
            let buf='',etype='',edata='';
            while(true){const{done,value}=await reader.read();if(done)break;buf+=decoder.decode(value,{stream:true});const lines=buf.split('\n');buf=lines.pop();for(const line of lines){if(line.startsWith('event:'))etype=line.slice(6).trim();else if(line.startsWith('data:'))edata=(edata?edata+'\n':'')+line.slice(5).trim();else if(line===''){this._handleEvent(etype,edata);etype='';edata='';}}}
        }catch(err){onError(err);}
    }
    _handleEvent(type,data){
        if(type==='endpoint'){try{this.messageEndpoint=new URL(data,this.sseUrl).toString();}catch{this.messageEndpoint=data;}if(this._onReady){this._onReady(this);this._onReady=null;}}
        else if(type==='message'||!type){try{const msg=JSON.parse(data);if(msg.id!==undefined&&this.pending[msg.id]){const{resolve,reject,timeout}=this.pending[msg.id];clearTimeout(timeout);delete this.pending[msg.id];msg.error?reject(new Error(msg.error.message||JSON.stringify(msg.error))):resolve(msg.result);}}catch(_){}}
    }
    async _request(method,params={}){
        if(!this.messageEndpoint)throw new Error('Not connected');
        const id=this.nextId++;
        const promise=new Promise((resolve,reject)=>{const timeout=setTimeout(()=>{if(this.pending[id]){delete this.pending[id];reject(new Error(`Timeout: ${method}`));}},15000);this.pending[id]={resolve,reject,timeout};});
        const resp=await fetch(this.messageEndpoint,{method:'POST',headers:{'Content-Type':'application/json','Authorization':`Bearer ${this.token}`},body:JSON.stringify({jsonrpc:'2.0',id,method,params})});
        if(!resp.ok&&resp.status!==202)throw new Error(`POST failed: ${resp.status}`);
        return promise;
    }
    initialize(){return this._request('initialize',{protocolVersion:'2024-11-05',capabilities:{},clientInfo:{name:'machu.la',version:'3.0'}});}
    listTools(){return this._request('tools/list',{});}
    callTool(name,args={}){return this._request('tools/call',{name,arguments:args});}
}

let _vaultClient=null;
function escHtml(t){const d=document.createElement('div');d.appendChild(document.createTextNode(t));return d.innerHTML;}

async function openVault(){
    const token=getVaultToken();
    if(!token){alert('Vault locked.\n\nVisit: machu.la/#vault-YOUR_GITHUB_TOKEN to unlock.');return;}
    const vo=document.getElementById('vault-overlay'),ce=document.getElementById('vault-content');
    vo.classList.add('active');setVaultStatus('ESTABLISHING NEURAL LINK...','connecting');
    ce.innerHTML='<div class="vault-loading" style="padding:1rem;">‚ü≥ Connecting...</div>';
    try{
        const client=new VaultMCPClient(VAULT_SSE_URL,token);
        setVaultStatus('AWAITING ENDPOINT...','connecting');await client.connect();
        await client.initialize();
        const tr=await client.listTools();const tools=tr?.tools||[];
        setVaultStatus(`VAULT OPEN ‚Äî ${tools.length} tool${tools.length!==1?'s':''} available`,'ok');
        _vaultClient=client;
        const sel=document.getElementById('vault-tool-select');sel.innerHTML='<option value="">‚Äî select tool ‚Äî</option>';
        tools.forEach(t=>{const o=document.createElement('option');o.value=t.name;o.textContent=`${t.name}${t.description?' ‚Äî '+t.description:''}`;sel.appendChild(o);});
        ce.innerHTML='';
        const rTools=tools.filter(t=>{const n=t.name.toLowerCase(),req=t.inputSchema?.required||[];return req.length===0||['list','get','all','read','search'].some(k=>n.includes(k));});
        if(!rTools.length)ce.innerHTML='<div class="vault-empty" style="padding:1rem;">Vault connected. Use the tool selector below.</div>';
        for(const tool of rTools.slice(0,6)){
            const sec=document.createElement('div');sec.className='vault-section';
            sec.innerHTML=`<div class="vault-section-header"><span class="vault-section-name">${escHtml(tool.name)}</span><span class="vault-section-desc">${escHtml(tool.description||'')}</span></div><div class="vault-section-content" id="vr-${escHtml(tool.name)}"><span class="vault-loading">Loading...</span></div>`;
            ce.appendChild(sec);
            client.callTool(tool.name,{}).then(r=>{const el=document.getElementById(`vr-${tool.name}`);if(el)el.innerHTML=renderVaultResult(r);}).catch(err=>{const el=document.getElementById(`vr-${tool.name}`);if(el)el.innerHTML=`<span class="vault-error">Error: ${escHtml(err.message)}</span>`;});
        }
    }catch(err){setVaultStatus('CONNECTION FAILED','error');document.getElementById('vault-content').innerHTML=`<div class="vault-error-state"><div style="font-size:1.1rem;margin-bottom:.8rem;">‚ö†Ô∏è VAULT ACCESS DENIED</div><div style="font-size:.78rem;margin-bottom:.8rem;">${escHtml(err.message)}</div><div style="font-size:.68rem;color:#553333;">Re-unlock: <code>machu.la/#vault-[NEW_TOKEN]</code></div></div>`;}
}

function setVaultStatus(msg,state){
    const t=document.getElementById('vault-status-text'),d=document.getElementById('vault-dot');
    if(t)t.textContent=msg;
    if(d){d.className='vault-status-dot';if(state==='error')d.classList.add('error');else if(state==='connecting')d.classList.add('connecting');}
}

function renderVaultResult(result){
    if(!result)return'<span class="vault-empty">No data returned</span>';
    let content=result;
    if(result.content&&Array.isArray(result.content)){const texts=result.content.filter(c=>c.type==='text').map(c=>c.text);if(texts.length){try{content=JSON.parse(texts.join(''));}catch{return`<div class="vault-text-result">${texts.map(t=>`<div class="vault-entry"><div class="vault-entry-main">${escHtml(t)}</div></div>`).join('')}</div>`;}}}
    if(content&&typeof content==='object'){for(const key of['records','data','entries','items','results','notes','documents']){if(content[key]&&Array.isArray(content[key])){content=content[key];break;}}}
    if(Array.isArray(content)){if(!content.length)return'<span class="vault-empty">No records found</span>';return`<div class="vault-records">${content.map(r=>renderVaultRecord(r)).join('')}</div>`;}
    if(typeof content==='object'&&content!==null)return`<div class="vault-records">${renderVaultRecord(content)}</div>`;
    return`<div class="vault-text-result">${escHtml(String(content))}</div>`;
}

function renderVaultRecord(rec){
    if(typeof rec==='string')return`<div class="vault-entry"><div class="vault-entry-main">${escHtml(rec)}</div></div>`;
    if(typeof rec!=='object'||rec===null)return`<div class="vault-entry"><div class="vault-entry-main">${escHtml(String(rec))}</div></div>`;
    const main=['title','name','content','text','note','body','entry','description','message','proof'].map(f=>rec[f]).find(Boolean);
    const date=['date','created','created_at','createdTime','timestamp','updated_at'].map(f=>rec[f]).find(Boolean);
    const tags=['tags','tag','category','type','status','labels'].map(f=>rec[f]).find(Boolean);
    if(!main)return`<div class="vault-entry">${Object.entries(rec).slice(0,8).map(([k,v])=>`<div><span style="color:#553333;">${escHtml(k)}:</span> <span style="color:#ffaaaa;">${escHtml(typeof v==='object'?JSON.stringify(v):String(v))}</span></div>`).join('')}</div>`;
    return`<div class="vault-entry"><div class="vault-entry-main">${escHtml(String(main))}</div>${date?`<div class="vault-entry-date">‚è± ${escHtml(String(date))}</div>`:''} ${tags?`<div class="vault-entry-tags">${(Array.isArray(tags)?tags:[tags]).map(t=>`<span class="vault-tag">${escHtml(String(t))}</span>`).join('')}</div>`:''}</div>`;
}

document.getElementById('vault-float-btn').addEventListener('click',e=>{e.preventDefault();openVault();});
document.getElementById('vault-close').addEventListener('click',()=>document.getElementById('vault-overlay').classList.remove('active'));
document.getElementById('vault-relock-btn').addEventListener('click',()=>{if(confirm('Clear vault token?')){localStorage.removeItem(VAULT_TOKEN_KEY);updateVaultUI();document.getElementById('vault-overlay').classList.remove('active');}});
document.getElementById('vault-submit-btn').addEventListener('click',async function(){
    if(!_vaultClient){alert('Open the vault first.');return;}
    const toolName=document.getElementById('vault-tool-select').value,text=document.getElementById('vault-new-entry').value.trim();
    if(!toolName){alert('Select a tool first.');return;}if(!text){alert('Enter some content first.');return;}
    this.textContent='TRANSMITTING...';this.disabled=true;
    try{await _vaultClient.callTool(toolName,{content:text,text,note:text,entry:text,body:text,message:text});document.getElementById('vault-new-entry').value='';this.textContent='‚úì TRANSMITTED';setTimeout(()=>{this.textContent='TRANSMIT';this.disabled=false;},2000);}
    catch(err){this.textContent=`‚úó ${err.message.slice(0,28)}`;setTimeout(()=>{this.textContent='TRANSMIT';this.disabled=false;},3000);}
});

// ================================================================
// ADMIN PANEL
// ================================================================
async function openAdmin() {
    const overlay = document.getElementById('admin-overlay');
    overlay.classList.add('active');
    const admin = getSbAdmin();
    document.getElementById('admin-key-gate').style.display = admin ? 'none' : 'block';
    document.getElementById('admin-main').style.display     = admin ? 'block' : 'none';
    if (admin) { initAdminOptionsList(); await loadAdminTab('question'); }
}

document.getElementById('admin-float-btn').addEventListener('click', openAdmin);
document.getElementById('admin-close').addEventListener('click', () => document.getElementById('admin-overlay').classList.remove('active'));

// Tab switching
document.querySelectorAll('.admin-tab').forEach(tab => {
    tab.addEventListener('click', async function() {
        document.querySelectorAll('.admin-tab').forEach(t => t.classList.remove('active'));
        document.querySelectorAll('.admin-panel').forEach(p => p.classList.remove('active'));
        this.classList.add('active');
        document.getElementById('admin-tab-' + this.dataset.tab).classList.add('active');
        await loadAdminTab(this.dataset.tab);
    });
});

async function loadAdminTab(tab) {
    const admin = getSbAdmin(); if (!admin) return;
    if (tab === 'question') {
        // Active question display
        const { data: active } = await admin.from('board_questions').select('*').eq('active', true).maybeSingle();
        const el = document.getElementById('admin-current-q');
        el.innerHTML = active
            ? `<strong>${escHtml(active.question)}</strong><br><span style="color:#2a5a2a;font-size:.75rem;">${active.options.map(o=>`${(o.label||o.id.toUpperCase())}: ${o.text}`).join(' &nbsp;¬∑&nbsp; ')}</span>`
            : '<span style="color:#2a5a2a;font-style:italic;">No active question set yet.</span>';
        // Question history with vote counts
        const { data: allQs } = await admin.from('board_questions')
            .select('id, question, active, options, created_at, votes(count)')
            .order('created_at', { ascending: false });
        const histEl = document.getElementById('admin-q-history');
        if (histEl) {
            if (!allQs || !allQs.length) {
                histEl.innerHTML = '<div style="color:#2a5a2a;font-size:.72rem;font-style:italic;">No questions yet.</div>';
            } else {
                histEl.innerHTML = allQs.map(q => {
                    const votes = q.votes?.[0]?.count ?? 0;
                    const isActive = !!q.active;
                    return `<div class="admin-q-history-item${isActive?' active-q':''}" data-qid="${q.id}">
                        <div style="display:flex;justify-content:space-between;align-items:flex-start;gap:.5rem;">
                            <div style="flex:1;min-width:0;">
                                <div style="font-size:.8rem;color:${isActive?'#4ADE80':'#a0c8a0'};line-height:1.5;margin-bottom:.25rem;">${escHtml(q.question)}</div>
                                <div style="font-size:.63rem;color:#2a5a2a;">${votes} vote${votes!==1?'s':''} &nbsp;¬∑&nbsp; ${new Date(q.created_at).toLocaleDateString()}</div>
                            </div>
                            <div style="flex-shrink:0;display:flex;gap:.3rem;flex-wrap:wrap;justify-content:flex-end;padding-top:.1rem;">
                                ${isActive
                                    ? '<span style="color:#4ADE80;font-size:.6rem;letter-spacing:1px;font-family:monospace;">ACTIVE</span>'
                                    : `<button class="admin-btn" style="font-size:.62rem;padding:.25rem .5rem;" onclick="activateQuestion('${q.id}')">Activate</button>`}
                                <button class="admin-btn" style="font-size:.62rem;padding:.25rem .5rem;" onclick="editQuestion('${q.id}')">Edit</button>
                                <button class="admin-btn" style="font-size:.62rem;padding:.25rem .5rem;border-color:#ff4444;color:#ff8888;" onclick="deleteQuestion('${q.id}',${escHtml(JSON.stringify(q.question))})">Del</button>
                            </div>
                        </div>
                    </div>`;
                }).join('');
            }
        }
    } else if (tab === 'pins') {
        const { data } = await admin.from('pins').select('*, votes(count)').order('created_at', { ascending: false });
        const tbody = document.getElementById('admin-pins-tbody');
        tbody.innerHTML = (!data || !data.length)
            ? '<tr><td colspan="5" style="color:#2a5a2a;font-style:italic;">No pins yet ‚Äî create one above.</td></tr>'
            : data.map(p => {
                const voteCount = p.votes?.[0]?.count ?? 0;
                return `<tr>
                <td><code style="color:#4ADE80;">${escHtml(p.code)}</code></td>
                <td id="pin-label-${p.id}">${escHtml(p.label||'‚Äî')}</td>
                <td><span class="admin-badge ${voteCount>0?'used':'unused'}">${voteCount} vote${voteCount!==1?'s':''}</span></td>
                <td style="color:#2a5a2a;">${new Date(p.created_at).toLocaleDateString()}</td>
                <td style="white-space:nowrap;">
                    <button class="admin-btn" style="font-size:.62rem;padding:.2rem .5rem;" onclick="editPin('${p.id}',${escHtml(JSON.stringify(p.label||''))})">Edit</button>
                    <button class="admin-btn" style="font-size:.62rem;padding:.2rem .5rem;border-color:#ff4444;color:#ff8888;" onclick="deletePin('${p.id}',${escHtml(JSON.stringify(p.code))})">Del</button>
                </td>
              </tr>`;}).join('');
    } else if (tab === 'results') {
        // Load questions for filter dropdown
        const { data: questions } = await admin.from('board_questions')
            .select('id, question, active').order('created_at', { ascending: false });
        const filterEl = document.getElementById('admin-results-filter');
        const prevFilter = filterEl?.value || '';
        if (filterEl) {
            filterEl.innerHTML = '<option value="">All questions</option>' +
                (questions||[]).map(q => `<option value="${q.id}"${q.active?' style="color:#4ADE80;"':''}${prevFilter===q.id?' selected':''}>${escHtml(q.question.slice(0,55))}${q.active?' ‚òÖ':''}</option>`).join('');
            filterEl.onchange = () => loadAdminTab('results');
        }
        const currentFilter = filterEl?.value || '';
        // Load votes
        let query = admin.from('votes')
            .select('*, pins(label,code), board_questions(id,question,options)')
            .order('created_at', { ascending: false });
        if (currentFilter) query = query.eq('question_id', currentFilter);
        const { data: votes } = await query;
        // Build pie charts per question
        const pieSection = document.getElementById('admin-pie-section');
        if (pieSection && votes && votes.length) {
            const qMap = {};
            votes.forEach(v => {
                const qid = v.question_id;
                if (!qMap[qid]) qMap[qid] = { question: v.board_questions?.question || '?', counts: {} };
                qMap[qid].counts[v.choice_text] = (qMap[qid].counts[v.choice_text] || 0) + 1;
            });
            pieSection.innerHTML = '<div class="admin-label" style="margin-bottom:.6rem;">Vote Breakdown</div>' +
                Object.values(qMap).map(qd => {
                    const pieData = Object.entries(qd.counts).map(([label, count]) => ({ label, count }));
                    return `<div style="margin-bottom:1rem;">
                        <div style="font-size:.7rem;color:#3a5a3a;margin-bottom:.5rem;font-family:monospace;">${escHtml(qd.question)}</div>
                        ${renderPieChart(pieData)}
                    </div>`;
                }).join('');
        } else if (pieSection) {
            pieSection.innerHTML = '';
        }
        // Render table
        const tbody = document.getElementById('admin-results-tbody');
        const dotStr = n => n ? '‚óè'.repeat(n) + '‚óã'.repeat(5 - n) : '‚Äî';
        tbody.innerHTML = (!votes || !votes.length)
            ? '<tr><td colspan="8" style="color:#2a5a2a;font-style:italic;">No votes yet.</td></tr>'
            : votes.map(v => `<tr>
                <td>${escHtml(v.pins?.label || v.pins?.code || '?')}</td>
                <td style="color:#3a5a3a;font-size:.68rem;max-width:160px;word-break:break-word;">${escHtml((v.board_questions?.question||'‚Äî').slice(0,45))}${(v.board_questions?.question||'').length>45?'‚Ä¶':''}</td>
                <td style="color:#4ADE80;">${escHtml(v.choice_text)}</td>
                <td style="font-size:.68rem;letter-spacing:1px;color:#4ADE80;white-space:nowrap;">${dotStr(v.closeness)}</td>
                <td style="font-size:.68rem;letter-spacing:1px;color:#4ADE80;white-space:nowrap;">${dotStr(v.expertise)}</td>
                <td style="color:#a0c8a0;font-size:.7rem;max-width:180px;word-break:break-word;">${v.justification ? escHtml(v.justification) : '<span style="color:#2a4a2a;">‚Äî</span>'}</td>
                <td style="color:#2a5a2a;white-space:nowrap;">${new Date(v.created_at).toLocaleString()}</td>
                <td><button class="admin-btn" style="font-size:.6rem;padding:.15rem .45rem;border-color:#ff4444;color:#ff8888;" onclick="deleteVote('${v.id}')">‚úï</button></td>
              </tr>`).join('');
    }
}

// ‚îÄ‚îÄ Pie chart renderer ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function renderPieChart(data) {
    const COLORS = ['#4ADE80','#FFD700','#60A5FA','#F472B6','#A78BFA','#34D399','#FB923C'];
    const total = data.reduce((s, d) => s + d.count, 0);
    if (!total) return '<span style="color:#2a5a2a;font-size:.72rem;">No votes yet</span>';
    const cx = 56, cy = 56, r = 50;
    let angle = -Math.PI / 2;
    const segs = data.map((d, i) => {
        const frac = d.count / total;
        const a0 = angle, a1 = angle + frac * 2 * Math.PI;
        angle = a1;
        if (frac >= 0.9999) {
            return { path: `M ${cx} ${cy-r} A ${r} ${r} 0 0 1 ${cx} ${cy+r} A ${r} ${r} 0 0 1 ${cx} ${cy-r} Z`, color: COLORS[i % COLORS.length], label: d.label, count: d.count, pct: 100 };
        }
        const x1 = cx + r * Math.cos(a0), y1 = cy + r * Math.sin(a0);
        const x2 = cx + r * Math.cos(a1), y2 = cy + r * Math.sin(a1);
        const large = frac > 0.5 ? 1 : 0;
        return { path: `M ${cx} ${cy} L ${x1} ${y1} A ${r} ${r} 0 ${large} 1 ${x2} ${y2} Z`, color: COLORS[i % COLORS.length], label: d.label, count: d.count, pct: Math.round(frac * 100) };
    });
    const paths = segs.map(s => `<path d="${s.path}" fill="${s.color}" stroke="#030303" stroke-width="1.5"/>`).join('');
    const legend = segs.map(s => `<div style="display:flex;align-items:center;gap:.35rem;margin-bottom:.25rem;">
        <span style="width:9px;height:9px;background:${s.color};border-radius:50%;flex-shrink:0;"></span>
        <span style="font-size:.7rem;color:#a0c8a0;">${escHtml(s.label)}: ${s.count} <span style="color:#4ADE80;">(${s.pct}%)</span></span>
    </div>`).join('');
    return `<div style="display:flex;align-items:center;gap:1.2rem;flex-wrap:wrap;">
        <svg width="112" height="112" viewBox="0 0 112 112" style="flex-shrink:0;">
            ${paths}
            <text x="${cx}" y="${cy+4}" text-anchor="middle" fill="#c8ffc8" font-family="monospace" font-size="11">${total}</text>
        </svg>
        <div>${legend}</div>
    </div>`;
}

// ‚îÄ‚îÄ Activate a past question ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
async function activateQuestion(qid) {
    const admin = getSbAdmin(); if (!admin) return;
    await admin.from('board_questions').update({ active: false }).neq('id', '00000000-0000-0000-0000-000000000000');
    await admin.from('board_questions').update({ active: true }).eq('id', qid);
    await loadAdminTab('question');
}

// ‚îÄ‚îÄ Edit question inline ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
async function editQuestion(qid) {
    const admin = getSbAdmin(); if (!admin) return;
    const { data: q } = await admin.from('board_questions').select('*').eq('id', qid).single();
    if (!q) return;
    const item = document.querySelector(`[data-qid="${qid}"]`);
    if (!item) return;
    item._editOpts = JSON.parse(JSON.stringify(q.options));
    const optsHtml = q.options.map((o, i) => `
        <div style="display:flex;gap:.35rem;margin-bottom:.3rem;align-items:center;">
            <span style="color:#2a5a2a;font-size:.65rem;min-width:22px;font-family:monospace;">${(o.label||o.id.toUpperCase())}</span>
            <input class="admin-input" style="margin:0;flex:1;font-size:.78rem;" value="${escHtml(o.text)}" data-opt-idx="${i}">
        </div>`).join('');
    item.innerHTML = `
        <div style="margin-bottom:.4rem;">
            <div style="font-size:.6rem;color:#2a5a2a;letter-spacing:1px;margin-bottom:.25rem;">QUESTION</div>
            <input class="admin-input" id="eq-text-${qid}" value="${escHtml(q.question)}" style="margin:0;">
        </div>
        <div style="margin-bottom:.5rem;">
            <div style="font-size:.6rem;color:#2a5a2a;letter-spacing:1px;margin-bottom:.25rem;">OPTIONS</div>
            ${optsHtml}
        </div>
        <div style="display:flex;gap:.4rem;">
            <button class="admin-btn primary" onclick="saveQuestion('${qid}')">Save ‚Üó</button>
            <button class="admin-btn" style="opacity:.6;" onclick="loadAdminTab('question')">Cancel</button>
        </div>`;
}

async function saveQuestion(qid) {
    const admin = getSbAdmin(); if (!admin) return;
    const item = document.querySelector(`[data-qid="${qid}"]`);
    if (!item || !item._editOpts) return;
    const newQ = document.getElementById(`eq-text-${qid}`)?.value.trim();
    if (!newQ) { alert('Question text is required.'); return; }
    const optInputs = item.querySelectorAll('[data-opt-idx]');
    const newOpts = item._editOpts.map((o, i) => ({ ...o, text: optInputs[i]?.value.trim() || o.text }));
    const saveBtn = item.querySelector('button');
    if (saveBtn) { saveBtn.textContent = 'Saving...'; saveBtn.disabled = true; }
    const { error } = await admin.from('board_questions').update({ question: newQ, options: newOpts }).eq('id', qid);
    if (error) { alert('Error: ' + error.message); if (saveBtn) { saveBtn.textContent = 'Save ‚Üó'; saveBtn.disabled = false; } }
    else await loadAdminTab('question');
}

async function deleteQuestion(qid, questionText) {
    if (!confirm(`Delete this question?\n\n"${questionText}"\n\nAll associated votes will also be removed.`)) return;
    const admin = getSbAdmin(); if (!admin) return;
    await admin.from('votes').delete().eq('question_id', qid);
    const { error } = await admin.from('board_questions').delete().eq('id', qid);
    if (error) alert('Error: ' + error.message);
    else await loadAdminTab('question');
}

// ‚îÄ‚îÄ Edit / delete PINs ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
async function editPin(pinId, currentLabel) {
    const cell = document.getElementById(`pin-label-${pinId}`);
    if (!cell) return;
    cell.innerHTML = `<input class="admin-input" id="pin-li-${pinId}" value="${escHtml(currentLabel)}" style="margin:0;width:100%;font-size:.75rem;" placeholder="Label...">`;
    const inp = document.getElementById(`pin-li-${pinId}`);
    inp.focus(); inp.select();
    let saved = false;
    async function save() {
        if (saved) return; saved = true;
        const newLabel = inp.value.trim() || null;
        const admin = getSbAdmin(); if (!admin) return;
        await admin.from('pins').update({ label: newLabel }).eq('id', pinId);
        await loadAdminTab('pins');
    }
    inp.addEventListener('blur', save);
    inp.addEventListener('keydown', e => {
        if (e.key === 'Enter') { e.preventDefault(); save(); }
        if (e.key === 'Escape') loadAdminTab('pins');
    });
}

async function deletePin(pinId, code) {
    if (!confirm(`Delete PIN "${code}"?\n\nThis will also remove their vote history.`)) return;
    const admin = getSbAdmin(); if (!admin) return;
    await admin.from('votes').delete().eq('pin_id', pinId);
    const { error } = await admin.from('pins').delete().eq('id', pinId);
    if (error) alert('Error: ' + error.message);
    else await loadAdminTab('pins');
}

// ‚îÄ‚îÄ Delete vote ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
async function deleteVote(voteId) {
    if (!confirm('Remove this vote? This cannot be undone.')) return;
    const admin = getSbAdmin(); if (!admin) return;
    const { error } = await admin.from('votes').delete().eq('id', voteId);
    if (error) alert('Error: ' + error.message);
    else await loadAdminTab('results');
}

// ‚îÄ‚îÄ Set new question ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
let _adminOpts = [{id:'a',text:''},{id:'b',text:''}];
let _adminOptsInited = false;

function initAdminOptionsList() {
    if (_adminOptsInited) return; _adminOptsInited = true;
    renderAdminOpts();
    document.getElementById('admin-add-option').addEventListener('click', () => {
        if (_adminOpts.length >= 5) return;
        _adminOpts.push({ id: String.fromCharCode(97 + _adminOpts.length), text: '' });
        renderAdminOpts();
    });
    document.getElementById('admin-set-question').addEventListener('click', async function() {
        const admin = getSbAdmin(); if (!admin) return;
        const q = document.getElementById('admin-new-q').value.trim();
        const opts = _adminOpts.filter(o => o.text.trim());
        if (!q)           { alert('Enter a question.'); return; }
        if (opts.length < 2) { alert('Need at least 2 options.'); return; }
        this.textContent = 'Saving...'; this.disabled = true;
        await admin.from('board_questions').update({ active: false }).neq('id', '00000000-0000-0000-0000-000000000000');
        const { error } = await admin.from('board_questions').insert({ question: q, options: opts, active: true });
        if (error) alert('Error: ' + error.message);
        else {
            document.getElementById('admin-new-q').value = '';
            _adminOpts = [{id:'a',text:''},{id:'b',text:''}]; renderAdminOpts();
            await loadAdminTab('question');
        }
        this.textContent = 'Make Active ‚Üó'; this.disabled = false;
    });
    document.getElementById('admin-create-pin').addEventListener('click', async function() {
        const admin = getSbAdmin(); if (!admin) return;
        const label = document.getElementById('admin-pin-label').value.trim();
        let   code  = document.getElementById('admin-pin-code').value.trim().toUpperCase();
        if (!code) code = Math.random().toString(36).slice(2,8).toUpperCase();
        this.textContent = 'Creating...'; this.disabled = true;
        const { error } = await admin.from('pins').insert({ code, label: label || null });
        if (error) alert(error.code==='23505' ? 'PIN already exists ‚Äî try another.' : error.message);
        else { document.getElementById('admin-pin-label').value=''; document.getElementById('admin-pin-code').value=''; await loadAdminTab('pins'); }
        this.textContent = 'Create ‚Üó'; this.disabled = false;
    });
}

function renderAdminOpts() {
    const el = document.getElementById('admin-options-list'); el.innerHTML = '';
    _adminOpts.forEach((opt, i) => {
        const row = document.createElement('div');
        row.style.cssText = 'display:flex;gap:.4rem;margin-bottom:.4rem;align-items:center;';
        row.innerHTML = `
            <span style="color:#2a5a2a;font-size:.68rem;min-width:50px;letter-spacing:1px;">OPT ${opt.id.toUpperCase()}</span>
            <input type="text" class="admin-input" value="${escHtml(opt.text)}" placeholder="Option text..." style="margin:0;flex:1;" data-idx="${i}">
            ${_adminOpts.length > 2 ? `<button style="background:transparent;border:1px solid #ff4444;color:#ff4444;padding:.3rem .5rem;cursor:pointer;font-family:monospace;font-size:.7rem;border-radius:2px;" data-remove="${i}">‚úï</button>` : ''}`;
        el.appendChild(row);
    });
    el.querySelectorAll('[data-idx]').forEach(inp => inp.addEventListener('input', function() { _adminOpts[+this.dataset.idx].text = this.value; }));
    el.querySelectorAll('[data-remove]').forEach(btn => btn.addEventListener('click', function() {
        _adminOpts.splice(+this.dataset.remove, 1);
        _adminOpts = _adminOpts.map((o,i) => ({ id: String.fromCharCode(97+i), text: o.text }));
        renderAdminOpts();
    }));
}

// Close admin on ESC (update existing ESC handler below)

(function initSpeech(){
    const SR=window.SpeechRecognition||window.webkitSpeechRecognition,micBtn=document.getElementById('vault-mic-btn'),textarea=document.getElementById('vault-new-entry');
    if(!SR){if(micBtn){micBtn.textContent='üé§ (n/a)';micBtn.disabled=true;}return;}
    const sr=new SR();sr.continuous=true;sr.interimResults=true;sr.lang='en-US';
    let isRec=false,finalText='';
    sr.onresult=e=>{let interim='';for(let i=e.resultIndex;i<e.results.length;i++){if(e.results[i].isFinal)finalText+=e.results[i][0].transcript;else interim+=e.results[i][0].transcript;}textarea.value=finalText+(interim?` [${interim}]`:'');};
    sr.onend=()=>{isRec=false;micBtn.textContent='üé§ DICTATE';micBtn.classList.remove('recording');textarea.value=textarea.value.replace(/\s*\[.*?\]/g,'').trim();};
    micBtn.addEventListener('click',()=>{if(isRec){sr.stop();}else{finalText=textarea.value;sr.start();isRec=true;micBtn.textContent='‚èπ STOP';micBtn.classList.add('recording');}});
})();
</script>
</body>
</html>
